\documentclass[aip,jcp,preprint,superscriptaddress,nofootinbib]{revtex4-1}
\usepackage{silence}
\WarningFilter{revtex4-1}{Repair the float}
\renewcommand{\thefootnote}{\alph{footnote}}

\input{preamble/general.tex}
\input{preamble/local.tex}
\input{preamble/abbreviations.tex}


\newcommand{\au}{Department of Chemistry, Aarhus University, Langelandsgade 140, 8000 Aarhus C, Denmark}


\begin{document}

\title{Relating orbital and parameter equations}
\author{Mads Greisen HÃ¸jlund}
\email{madsgh@chem.au.dk}
\affiliation{\au}

\date{\today}
\maketitle

\tableofcontents
\newpage



\section{Notation} \label{sec:notation}

The Hamiltonian is written using physicist's notation for the integrals (which are not anti-symmetrized):
\begin{align}
    H = \sum_{pq} h_{pq} \crea{p} \anni{q} + \frac{1}{2} \sum_{pqrs} u_{pqrs} \crea{p} \crea{q} \anni{s} \anni{r}
\end{align}
\begin{align}
    h_{pq} 
    = \elm{\phibra{p}}{h}{\phiket{q}} 
    \equiv \int \phibra{p}(\mathbf{x}) h(\mathbf{x}) \phiket{q}(\mathbf{x}) \dd{\mathbf{x}}
\end{align}
\begin{align}
    u_{pqrs} 
    = \elm{\phibra{p} \phibra{q}}{u}{\phiket{r} \phiket{s}}
    \equiv \iint \phibra{p}(\mathbf{x}) \phibra{q}(\mathbf{y}) u(\mathbf{x}, \mathbf{y}) \phiket{r}(\mathbf{x}) \phiket{s}(\mathbf{y}) \dd{\mathbf{x}} \dd{\mathbf{y}}
\end{align}
Density matrices are defined as
\begin{align}
    \rho_{qp}   &= \elm{\tilde{\Psi}}{ \crea{p} \anni{q} }{\Psi}, \\
    \rho_{rspq} &= \elm{\tilde{\Psi}}{ \crea{p} \crea{q} \anni{s} \anni{r} }{\Psi}.
\end{align}
The two-electron integrals and densities have the following useful permutation symmetries:
\begin{align}
    u_{pqrs}    &= u_{qpsr}, \label{eq:u_permutation_symmetry}\\
    \rho_{rspq} &= \rho_{srqp}.
\end{align}

Using Einstein notation, the non-symmetrized and anti-symmetrized two-electron integrals
are related by
\begin{align} \label{eq:antisymmetric_integrals_proof}
    \tfrac{1}{2} u_{pqrs} \crea{p} \crea{q} \anni{s} \anni{r}
    &= \tfrac{1}{4} u_{pqrs} \crea{p} \crea{q} \anni{s} \anni{r}
    +  \tfrac{1}{4} u_{pqrs} \crea{p} \crea{q} \anni{s} \anni{r} \nn
    &= \tfrac{1}{4} u_{pqrs} \crea{p} \crea{q} \anni{s} \anni{r}
    +  \tfrac{1}{4} u_{pqsr} \crea{p} \crea{q} \anni{r} \anni{s} \nn
    &= \tfrac{1}{4} u_{pqrs} \crea{p} \crea{q} \anni{s} \anni{r}
    -  \tfrac{1}{4} u_{pqsr} \crea{p} \crea{q} \anni{s} \anni{r} \nn
    &= \tfrac{1}{4}  (u_{pqrs} - u_{pqsr}) \crea{p} \crea{q} \anni{s} \anni{r} \nn
    &\equiv \tfrac{1}{4}  w_{pqrs} \crea{p} \crea{q} \anni{s} \anni{r}.
\end{align}
The second step simply swaps summations indices $r$ and $s$ in the second
term, and the third step uses the anti-commutator $\{\anni{r},  \anni{s} \} = 0$.
The anti-symmetrized integrals,
\begin{align}
    w_{pqrs} = u_{pqrs} - u_{pqsr} = u_{pqrs} - u_{qprs},
\end{align}
have the following symmetries:
\begin{align}
    w_{pqrs} = -w_{pqsr} = -w_{qprs} = w_{qpsr}.
\end{align}
% The first equality holds by construction, while the second follows from Eq.~\eqref{eq:u_permutation_symmetry}.
Using the same kind of reasoning that led to Eq.~\eqref{eq:antisymmetric_integrals_proof}, 
we can generally write
\begin{subequations}
    \begin{align}
        \sum_{rs} u_{pqrs} \anni{s} \anni{r} &= \frac{1}{2} \sum_{rs} w_{pqrs} \anni{s} \anni{r} \\
        \sum_{rs} u_{pqrs} \crea{s} \crea{r} &= \frac{1}{2} \sum_{rs} w_{pqrs} \crea{s} \crea{r} \\
        \sum_{pq} u_{pqrs} \anni{p} \anni{q} &= \frac{1}{2} \sum_{pq} w_{pqrs} \anni{p} \anni{q} \\
        \sum_{pq} u_{pqrs} \crea{p} \crea{q} &= \frac{1}{2} \sum_{pq} w_{pqrs} \crea{p} \crea{q}.
    \end{align}
\end{subequations}

In the following, we use $o,p,q,r,s$ to index active orbitals. In coupled cluster
theory, the active orbitals are additionally divided into reference/occupied orbitals ($i,j,\ldots$)
and virtual orbitals ($a,b,\ldots$).


\section{Converting orbital equations to parameter equations}
The orbital equations are formally identical for all orbital-adaptive methods.
Following Kvaal\cite{kvaalInitioQuantumDynamics2012} and Sato\cite{satoCommunicationTimedependentOptimized2018}, 
they take the appearance
\begin{subequations}
    \begin{align}
        i \ket{\phiketdot{p}} 
        &= +i \sum_{q} \ket{\phiket{q}} \eta_{qp}
        + Q \Big[
        h \ket{\phiket{p}} + \sum_{oqrs} W_{rs} \ket{\phiket{q}} P_{qsor} \, (\mathbf{D}^{-1})_{op}
        \Big], \label{eq:phiket_dot} \\
        i \bra{\phibradot{p}} 
        &= -i \sum_{q} \eta_{pq} \bra{\phibra{q}} -
        \Big[
        \bra{\phibra{p}} h + \sum_{oqrs} (\mathbf{D}^{-1})_{po} \, P_{orqs}  \bra{\phibra{q}} W_{sr} 
        \Big] Q. \label{eq:phibra_dot}
    \end{align}
\end{subequations}
The mean-field operator\cite{miyagiTimedependentRestrictedactivespaceSelfconsistentfield2013,satoTimedependentCompleteactivespaceSelfconsistentfield2013}
$W_{rs}$ is a multiplicative/local operator given by
\begin{align}
    W_{rs} (\mathbf{x}) = \int \phibra{r} (\mathbf{y}) u(\mathbf{x}, \mathbf{y}) \phiket{s} (\mathbf{y}) \dd{\mathbf{y}}.
\end{align}
Kvaal\cite{kvaalInitioQuantumDynamics2012} uses a slightly different notation, but the meaning should be the same. 
The secondary-space projector is given by
\begin{align}
    Q = 1 - \sum_{p} \ket{\phiket{p}} \! \bra{\phibra{p}}.
\end{align}
The definitions of the densities depend on whether biorthogonal\cite{kvaalInitioQuantumDynamics2012}
or orthogonal\cite{satoTimedependentCompleteactivespaceSelfconsistentfield2013} orbitals are used.
In the biorthogonal case, the plain one- and two-electron densities are used:
\begin{align}
    D_{qp}   &= \rho_{qp}, \\
    P_{rspq} &= \rho_{rspq}.
\end{align}
In the orthogonal case, the densities are Hermitianized according to
\begin{align}
    D_{qp}   &= \tfrac{1}{2} ( \rho_{qp}   + \rho_{pq}^*   ), \\
    P_{rspq} &= \tfrac{1}{2} ( \rho_{rspq} + \rho_{pqrs}^* ).
\end{align}
Having an orthogonal basis of course means $\bra{\phibra{p}} = \bra{\phiket{p}}$,
which implies $Q = Q^{\dagger}$ and $W_{rs}^* = W_{sr}$. Using these relations
and the Hermitianized densities one easily confirms that Eqs.~\eqref{eq:phiket_dot}
and \eqref{eq:phibra_dot} are simply each other's adjoint
when the orbitals are orthogonal.

We now introduce an underlying/primitive basis that is indexed by greek subscripts and assumed to be biorthonormal.
The time-dependent, active orbitals are given in terms of this basis as
\begin{align}
    \ket{\phiket{p}} = \sum_{\alpha} \ket{\chiket{\alpha}} C_{\alpha p},         \label{eq:phi_ket_expansion} \\
    \bra{\phibra{p}} = \sum_{\alpha} \tilde{C}_{p \alpha} \bra{\chibra{\alpha}}, \label{eq:phi_bra_expansion}
\end{align}
with time-dependent coefficients. 
Using $N$ and $N_{\!\textsc{A}} \leq N$ to denote the number of primitive and active
basis functions, respectively, we have that
$\mathbf{C}$         is $N \times N_{\!\textsc{A}}$ (tall) and 
$\tilde{\mathbf{C}}$ is $N_{\!\textsc{A}} \times N$ (wide).
The primitive basis induces the following identity in
the one-particle space:
\begin{align}
    1 = \sum_{\beta} \ket{\chiket{\beta}} \! \bra{\chibra{\beta}} 
\end{align}
Inserting this identity into Eq.~\eqref{eq:phiket_dot} and projecting onto $\bra{\chibra{\alpha}}$ yields
\begin{multline}
    i \braket{\chibra{\alpha} | \phiketdot{p}} 
    = i \sum_{q} \braket{\chibra{\alpha} | \phiket{q}} \eta_{qp}
    + \sum_{\beta} \elm{\chibra{\alpha}}{Q}{\chiket{\beta}} \Big[
    \elm{\chibra{\beta}}{h}{\phiket{p}}
    + \sum_{oqrs}  \elm{\chibra{\beta}}{W_{rs}}{\phiket{q}} P_{qsor} \, (\mathbf{D}^{-1})_{op}
    \Big].
\end{multline}
Introducing matrix notation, this reads
\begin{align} \label{eq:C_dot}
    i \dot{\mathbf{C}} 
    &= i \mathbf{C} \bm{\eta} + 
    \mathbf{Q}  \big( \check{\mathbf{H}} + \check{\mathbf{F}} \mathbf{D}^{-1} \big) \nn
    &= i \mathbf{C} \bm{\eta} + 
    \mathbf{Q}  \big( \check{\mathbf{H}} \mathbf{D} + \check{\mathbf{F}} \big) \mathbf{D}^{-1} .
\end{align}
The secondary-space projector has matrix elements
\begin{align}
    Q_{\alpha \beta} 
    &= \elm{\chibra{\alpha}}{Q}{\chiket{\beta}} \nn
    &= \elm{\chibra{\alpha}}{(1 - P)}{\chiket{\beta}} \nn
    &= \braket{\chibra{\alpha} | \chiket{\beta}} - \sum_{p} \braket{\chibra{\alpha} | \phiket{p}} \braket{\phibra{p} | \chiket{\beta}}
\end{align}
or simply
\begin{align} \label{eq:Q_proj_matrix}
    \mathbf{Q} = \mathbf{1} - \mathbf{C} \tilde{\mathbf{C}}.
\end{align}
The matrices $\check{\mathbf{H}}$ and $\check{\mathbf{F}}$ contain
half-transformed one-electron integrals,
\begin{gather}
    \check{H}_{\beta p} = \elm{\chibra{\beta}}{h}{\phiket{p}} = h_{\beta p},
\end{gather}
and half-transformed mean-field elements,
\begin{align}
    \check{F}_{\beta o}
    &= \sum_{qrs}  \elm{\chibra{\beta}}{W_{rs}}{\phiket{q}} P_{qsor} \nn
    &= \sum_{qrs}
    \int \chibra{\beta} (\mathbf{x}) \left[ 
    \int \phibra{r}(\mathbf{y}) u(\mathbf{x}, \mathbf{y}) \phiket{s}(\mathbf{y})  \dd{\mathbf{y}} 
    \right] \phiket{q} (\mathbf{x}) \dd{\mathbf{x}}
    P_{qsor} \nn
    &= \sum_{qrs}
    \iint \chibra{\beta} (\mathbf{x}) \phibra{r}(\mathbf{y}) u(\mathbf{x}, \mathbf{y}) \phiket{q} (\mathbf{x}) \phiket{s}(\mathbf{y}) \dd{\mathbf{x}} \dd{\mathbf{y}} 
    P_{qsor} \nn
    &= \sum_{qrs}  u_{\beta r q s} P_{qsor} \nn
    &= \frac{1}{2} \sum_{qrs}  w_{\beta r q s} P_{qsor}. \label{eq:F_check_from_u_and_rho}
\end{align}
Using similar steps, Eq.~\eqref{eq:phibra_dot} leads to
\begin{align} \label{eq:C_tilde_dot}
    i \dot{\tilde{\mathbf{C}}} 
    &= -i  \bm{\eta} \tilde{\mathbf{C}} - 
    \big( \check{\mathbf{H}}' + \mathbf{D}^{-1} \check{\mathbf{F}}' \big) \mathbf{Q} \nn
    &= -i  \bm{\eta} \tilde{\mathbf{C}} - 
    \mathbf{D}^{-1} \big( \mathbf{D} \check{\mathbf{H}}' + \check{\mathbf{F}}' \big) \mathbf{Q}
\end{align}
with
\begin{subequations} \label{eq:F_check_prime_from_u_and_rho}
    \begin{gather}
        \check{H}'_{p \beta} = \elm{\phibra{p}}{h}{\chiket{\beta}} = h_{p \beta},  \\
        \check{F}'_{o \beta} 
        = \sum_{qrs} P_{osqr} \elm{\phibra{q}}{ W_{rs} }{\chiket{\beta}}
        = \sum_{qrs} P_{osqr} u_{qr\beta s}
        = \frac{1}{2} \sum_{qrs} P_{osqr} w_{qr\beta s}. \label{eq:F_check_prime_from_u_and_rho_b}
    \end{gather}
\end{subequations}

When the active basis is orthogonal ($\tilde{\mathbf{C}} = \mathbf{C}^{\dagger}$), we gain a lot of
additional structure (at least when the primitive basis is also taken to be orthogonal):
\begin{gather}
    \mathbf{Q}^{\dagger}          = \mathbf{Q}, \quad 
    \mathbf{D}^{\dagger}          = \mathbf{D}, \quad 
    (\mathbf{D}^{-1})^{\dagger}   = \mathbf{D}^{-1} \\
    \check{\mathbf{H}}^{\dagger}  = \check{\mathbf{H}}^{\prime}, \quad 
    \check{\mathbf{F}}^{\dagger}  = \check{\mathbf{F}}^{\prime}, \quad
    \bm{\eta}^{\dagger}           = -\bm{\eta}
\end{gather}
All of these (except the last) are easy to show and imply that
$\dot{\mathbf{C}}^{\dagger} = \dot{\tilde{\mathbf{C}}}$ as expected;
see Eqs.~\eqref{eq:C_dot} and \eqref{eq:C_tilde_dot}.

\section{Relation to other work}
\subsection{Biorthogonal case}
In Refs.~\citenum{madsenTimedependentVibrationalCoupled2020} and \citenum{hojlundBivariationalTimedependentWave2022},
the parameter equations were derived (for the biorthogonal case) by assuming the expansions in
Eqs.~\eqref{eq:phi_ket_expansion} and \eqref{eq:phi_bra_expansion} from the outset.
Those derivations also apply to the electronic structure problem
(this is an explicit point in Ref.\citenum{hojlundBivariationalTimedependentWave2022}), so we
should check that they agree with Eqs.~\eqref{eq:C_dot} and \eqref{eq:C_tilde_dot}.
Ignoring notational differences, we need to check that
\begin{subequations} \label{eq:F_check_correspondence_ab}
    \begin{align}
        \big[ \check{\mathbf{H}} \mathbf{D} + \check{\mathbf{F}} \big]_{\bar{\alpha} \bar{p}}
        &= \elm{\tilde{\Psi}}{ \crea{\bar{p}} [\anniprim{\bar{\alpha}}, H] }{\Psi},  \label{eq:F_check_correspondence} \\
        \big[ \mathbf{D} \check{\mathbf{H}}' + \check{\mathbf{F}}' \big]_{\bar{p} \bar{\alpha}} 
        &= \elm{\tilde{\Psi}}{ [H, \creaprim{\bar{\alpha}}] \anni{\bar{p}}  }{\Psi}.  \label{eq:F_check_prime_correspondence}
    \end{align}
\end{subequations}
Here, the operators $\creaprim{\bar{\alpha}}$ and $\anniprim{\bar{\alpha}}$ create and annihilate
the primitive basis. We note that
\begin{align}
    \{ \anniprim{\bar{\alpha}}, \crea{p} \} &= C_{\bar{\alpha} p}, \\
    \{ \anniprim{\bar{\alpha}}, \anni{p} \} &= 0, \\
    \{ \anni{p}, \creaprim{\bar{\alpha}} \} &= \tilde{C}_{p \bar{\alpha}}, \\
    \{ \crea{p}, \creaprim{\bar{\alpha}} \} &= 0,
\end{align}
which implies the following commutators:
\begin{align}
    [\anniprim{\bar{\alpha}}, \crea{p} \anni{q}] 
    &= \{ \anniprim{\bar{\alpha}}, \crea{p} \} \anni{q} - \crea{p} \{ \anniprim{\bar{\alpha}}, \anni{q} \} \nn
    &= C_{\bar{\alpha} p} \anni{q}
\end{align}
%
\begin{align}
    [\crea{p} \anni{q}, \creaprim{\bar{\alpha}}] 
    &= - \{ \crea{p}, \creaprim{\bar{\alpha}} \} \anni{q} + \crea{p} \{ \anni{q}, \creaprim{\bar{\alpha}} \} \nn
    &= \crea{p} \tilde{C}_{q \bar{\alpha}} 
\end{align}
%
\begin{align}
    [\anniprim{\bar{\alpha}}, \crea{p} \crea{q} \anni{s} \anni{r}] 
    &= \{ \anniprim{\bar{\alpha}}, \crea{p} \} \crea{q} \anni{s} \anni{r} 
     - \crea{p} \{ \anniprim{\bar{\alpha}}, \crea{q} \} \anni{s} \anni{r}
     + \crea{p} \crea{q} \{ \anniprim{\bar{\alpha}}, \anni{s} \} \anni{r}
     - \crea{p} \crea{q} \anni{s} \{ \anniprim{\bar{\alpha}}, \anni{r} \}  \nn
    &= C_{\bar{\alpha} p} \crea{q} \anni{s} \anni{r} - C_{\bar{\alpha} q} \crea{p} \anni{s} \anni{r}
\end{align}
%
\begin{align}
    [\crea{p} \crea{q} \anni{s} \anni{r}, \creaprim{\bar{\alpha}} ] 
    &= 
    - \{ \crea{p}, \creaprim{\bar{\alpha}} \} \crea{q} \anni{s} \anni{r} 
    + \crea{p} \{ \crea{q}, \creaprim{\bar{\alpha}} \} \anni{s} \anni{r}
    - \crea{p} \crea{q} \{ \anni{s}, \creaprim{\bar{\alpha}} \} \anni{r}
    + \crea{p} \crea{q} \anni{s} \{ \anni{r}, \creaprim{\bar{\alpha}} \}  \nn
    &= -\crea{p} \crea{q} \anni{r} \tilde{C}_{s \bar{\alpha}} + \crea{p} \crea{q} \anni{s} \tilde{C}_{r \bar{\alpha}} 
\end{align}
The right-hand side of Eq.~\eqref{eq:F_check_correspondence} now becomes
\begin{align}
    \elm{\tilde{\Psi}}{ \crea{\bar{p}} [\anniprim{\bar{\alpha}}, H] }{\Psi} 
    &= \sum_{pq} h_{pq} \elm{\tilde{\Psi}}{ \crea{\bar{p}} [\anniprim{\bar{\alpha}}, \crea{p} \anni{q}] }{\Psi}
    + \frac{1}{2} \sum_{pqrs} u_{pqrs} \elm{\tilde{\Psi}}{ \crea{\bar{p}} [\anniprim{\bar{\alpha}}, \crea{p} \crea{q} \anni{s} \anni{r}] }{\Psi} \nn
    &= 
    \begin{multlined}[t]
        \sum_{pq} C_{\bar{\alpha} p} h_{pq} \elm{\tilde{\Psi}}{ \crea{\bar{p}} \anni{q} }{\Psi} \\
        + \frac{1}{2} \sum_{pqrs} \left( 
            C_{\bar{\alpha} p} u_{pqrs} \elm{\tilde{\Psi}}{ \crea{\bar{p}} \crea{q} \anni{s} \anni{r} }{\Psi} -
            C_{\bar{\alpha} q} u_{pqrs} \elm{\tilde{\Psi}}{ \crea{\bar{p}} \crea{p} \anni{s} \anni{r} }{\Psi}
        \right)
    \end{multlined} \nn
    &=  \sum_{pq} C_{\bar{\alpha} p} h_{pq} \rho_{q \bar{p}}
    + \frac{1}{2} \sum_{pqrs} \left( 
        C_{\bar{\alpha} p} u_{pqrs} \rho_{rs \bar{p} q} -
        C_{\bar{\alpha} q} u_{pqrs} \rho_{rs \bar{p} p}
    \right) \label{eq:F_check_correspondence_proof_1}
\end{align}
The last term can be simplified by renaming summation indices ($p \leftrightarrow q$ and $r \leftrightarrow s$)
followed by the identities $u_{qpsr} = u_{pqrs}$ and
$\rho_{sr\bar{p}q} = -\rho_{rs\bar{p}q}$:
\begin{align}
       \sum_{pqrs} C_{\bar{\alpha} q} u_{pqrs} \rho_{rs \bar{p} p} 
    =  \sum_{pqrs} C_{\bar{\alpha} p} u_{qpsr} \rho_{sr \bar{p} q}
    = -\sum_{pqrs} C_{\bar{\alpha} p} u_{pqrs} \rho_{rs \bar{p} q}.
\end{align}
Combining this with Eq.~\eqref{eq:F_check_correspondence_proof_1} now yields
\begin{align}
    \elm{\tilde{\Psi}}{ \crea{\bar{p}} [\anniprim{\bar{\alpha}}, H] }{\Psi} 
    &= \sum_{pq}   C_{\bar{\alpha} p} h_{pq}   \rho_{q \bar{p}}
    +  \sum_{pqrs} C_{\bar{\alpha} p} u_{pqrs} \rho_{rs \bar{p} q}  \nn
    &= \sum_{q}    h_{\bar{\alpha} q}   \rho_{q \bar{p}}
    +  \sum_{qrs}  u_{\bar{\alpha} qrs} \rho_{rs \bar{p} q}
    \label{eq:F_check_correspondence_proof_2}
\end{align}
which agrees with Eqs.~\eqref{eq:F_check_from_u_and_rho} and \eqref{eq:F_check_correspondence}.
In the last step we have used
\begin{align}
    \sum_{p}  C_{\bar{\alpha} p} h_{pq} 
    = \sum_{p \beta} C_{\bar{\alpha} p} \tilde{C}_{p \beta} h_{\beta q}
    = h_{\bar{\alpha} q}.
\end{align}
This holds if
\begin{align} \label{eq:C_C_tilde_inverse}
    \sum_{p \beta} C_{\bar{\alpha} p} \tilde{C}_{p \beta} = \delta_{\bar{\alpha} \beta},
\end{align}
which is \textit{not} true if the $p$ summation runs over active (occupied and virtual) orbitals. However,
since the primitive basis is finite,
we are free to temporarily introduce the secondary basis (i.e. the complement of the active basis) explicitly.
This means that $\mathbf{C}$ and $\tilde{\mathbf{C}}$ become square (rather than rectangular) matrices:
\begin{alignat}{2}
    \mathbf{C} 
    &= 
    \left[
	\begin{array}{c}
        \mathbf{C}_{\textsc{A}}
	\end{array} \right]
    %
    {} &&\rightarrow
    \left[
	\begin{array}{c | c}
        \mathbf{C}_{\textsc{A}} {\,} & {\,} \mathbf{C}_{\textsc{S}} 
	\end{array} \right] \\
    %%%%
    \tilde{\mathbf{C}} 
    &= 
    \left[
	\begin{array}{c}
        \tilde{\mathbf{C}}_{\textsc{A}}
	\end{array} \right]
    %
    {} &&\rightarrow
    \left[
	\begin{array}{c}
        \tilde{\mathbf{C}}_{\textsc{A}} \\
        \hline
        \tilde{\mathbf{C}}_{\textsc{S}} 
	\end{array} \right]
\end{alignat}
Since the full matrices are square we get that biorthogonality ($\tilde{\mathbf{C}} \mathbf{C} = \mathbf{1}$)
implies $\mathbf{C}  \tilde{\mathbf{C}} = \mathbf{1}$, which is exactly Eq.~\eqref{eq:C_C_tilde_inverse}.
We will never actually construct the secondary basis; we only need its \textit{existence} to complete the proof.
A similar derivation shows that
\begin{align} \label{eq:F_check_prime_correspondence_proof_2}
    \elm{\tilde{\Psi}}{ [H, \creaprim{\bar{\alpha}}] \anni{\bar{p}}  }{\Psi}
    = \sum_{p} \rho_{\bar{p}p} h_{p \bar{\alpha}} + \sum_{pqs} \rho_{\bar{p}spq} u_{pq\bar{\alpha}s},
\end{align}
which agrees with Eqs.~\eqref{eq:F_check_prime_from_u_and_rho} and \eqref{eq:F_check_prime_correspondence}.

\subsection{Orthogonal case}

In the orthogonal case, one can also derive the parameter equations
by assuming the expansion in a primitive basis from the outset.
These equations are not yet published, but the thing we need to check is
that
\begin{align}
    \big[ \check{\mathbf{H}} \mathbf{D} + \check{\mathbf{F}} \big]_{\bar{\alpha} \bar{p}}
    &= \frac{1}{2} \left( 
        \elm{\tilde{\Psi}}{ \crea{\bar{p}} [\anniprim{\bar{\alpha}}, H] }{\Psi} + 
        \elm{\tilde{\Psi}}{ [H, \creaprim{\bar{\alpha}}] \anni{\bar{p}} }{\Psi}^* 
    \right).
    \label{eq:F_check_correspondence_orthogonal}
\end{align}
We can reuse Eqs.~\eqref{eq:F_check_correspondence_proof_2} and \eqref{eq:F_check_prime_correspondence_proof_2}
for the commutators as well as the permutation symmetries
\begin{align}
    h_{p \bar{\alpha}}^*     &= h_{\bar{\alpha} p}, \\
    u_{p q \bar{\alpha} s}^* &= u_{\bar{\alpha} s p q},
\end{align}
which hold when the active and primitive bases are both orthogonal. After some renaming
of summation indices, one indeed finds that
\begin{align}
    \frac{1}{2} \left( 
        \elm{\tilde{\Psi}}{ \crea{\bar{p}} [\anniprim{\bar{\alpha}}, H] }{\Psi} + 
        \elm{\tilde{\Psi}}{ [H, \creaprim{\bar{\alpha}}] \anni{\bar{p}} }{\Psi}^* 
    \right)
    = \sum_{q} h_{\bar{\alpha} q} D_{q \bar{p}} + \sum_{qrs} u_{\bar{\alpha} q r s} P_{rs \bar{p} q},
\end{align}
in agreement with Eqs.~\eqref{eq:F_check_from_u_and_rho} and \eqref{eq:F_check_correspondence_orthogonal}.

\subsection{Right-hand sides}

% The NOCC states can be parameterized as
% \begin{subequations}
%     \begin{align}
%         \ket{\Psi} 
%         &= e^{\hat{\kappa}} \ket{\psi} \nn
%         &= e^{\hat{\kappa}} e^{T} \ket{\Phi}, \\
%         \bra{\tilde{\Psi}} 
%         &= \bra{\tilde{\psi}} e^{-\hat{\kappa}} \nn
%         &= \bra{\tilde{\Phi}} \Lambda e^{-T} e^{-\hat{\kappa}}.
%     \end{align}
% \end{subequations}
% The appropriate energy function is
% \begin{align}
%     \mathcal{H} 
%     = \elm{\tilde{\Psi}}{H}{\Psi} 
%     = \elm{\tilde{\psi}}{ e^{-\hat{\kappa}} H e^{\hat{\kappa}} }{\psi}
%     = \elm{\tilde{\psi}}{ \bar{H} }{\psi},
% \end{align}
% and equations for the parameters $z_i \in \{ t_\mu, \lambda_\mu, \kappa_{pq} \}$ are obtained from
% \begin{align}
%     \pdv{\mathcal{H}}{z_i} = 0.
% \end{align}
% At the point $\hat{\kappa} = 0$, the orbital gradient
% takes on a particularly simple form, namely
The right-hand sides of the $\bm{\eta}$ equations
involve commutators like 
\begin{align}
       \elm{\tilde{\Psi}}{ [H, \crea{p} \anni{q}]   }{ \Psi }
    &= \elm{\tilde{\Psi}}{ [H, \crea{p} ] \anni{q}  }{ \Psi }
    +  \elm{\tilde{\Psi}}{ \crea{p} [H,  \anni{q} ] }{ \Psi } \nn
    &= \elm{\tilde{\Psi}}{ [H, \crea{p} ] \anni{q}  }{ \Psi }
    -  \elm{\tilde{\Psi}}{ \crea{p} [\anni{q}, H ]  }{ \Psi }.
\end{align}
Referring to Eqs.~\eqref{eq:F_check_correspondence_ab}, we find that
\begin{subequations}
    \begin{align}
        \breve{F}_{qp} 
        &\equiv \big[ \tilde{\mathbf{C}} (\check{\mathbf{H}} \mathbf{D} + \check{\mathbf{F}}) \big]_{q p} \nn
        &= \elm{\tilde{\psi}}{ \crea{p} [\anni{q}, H] }{\psi},  \\
        \breve{F}'_{qp} 
        &\equiv\big[ (\mathbf{D} \check{\mathbf{H}}' + \check{\mathbf{F}}' ) \mathbf{C} \big]_{q p} \nn
        &= \elm{\tilde{\psi}}{ [H, \crea{p}] \anni{q}  }{\psi}.
    \end{align}
\end{subequations}
The commutator can now be written as
\begin{align}
    \elm{\tilde{\Psi}}{ [H, \crea{p} \anni{q}] }{ \Psi } = \breve{F}_{qp} - \breve{F}'_{qp}.
\end{align}
The matrices $\breve{\mathbf{F}}$ and $\breve{\mathbf{F}}'$ are
easily computed from quantities that are anyway needed for the
orbital equations.

\section{Detailed derivation of orbital equations}
\subsection{Biorthogonal case}
This derivation follows the supplementary material of Ref.~\citenum{kvaalInitioQuantumDynamics2012}
quite closely, but explains the steps in more detail. We consider a complex
action functional,
\begin{align}
    \mathcal{S} = \int_{t_0}^{t_1} \mathcal{L} \dd{t}, \quad \mathcal{L} = \elm{\tilde{\Psi}}{(i \partial_t - H)}{\Psi},
\end{align}
which we will make stationary ($\delta \mathcal{S} = 0$) with respect to independent
and arbitrary variations that vanish at the end points. 

We will consider bra and ket states that depend on a set of correlation
parameters $\bm{\alpha}$ as well as the active bra and ket orbitals,
$\{ \phibra{p} \}$ and $\{ \phiket{p} \}$. The orbitals stand in 
a one-to-one relationship with the corresponding annihilators
and creators, $\{ \anni{p} \}$ and $\{ \crea{p} \}$, and
we will use the `first-quantized' orbitals and the `second-quantized'
elementary operators more or less interchangeably, depending on
context and convenience.
For the traditional coupled cluster
ansatz, the correlation parameters are of course the amplitudes
$\bm{\alpha} = \{ \lambda_\mu, t_\mu \}$, but we could consider
other options such extended coupled cluster or bivariational CI-expansions.

In order to compute the Lagrangian $\mathcal{L}$, we need to consider
the action of the time-derivative on the ket. It is useful to start by
considering a single Slater determinant (in the spin-orbital basis):
\begin{align}
    \ket{\mu} = \prod_{k=1}^N \creasuper{p}{k} \ket{\mathrm{vac}}.
\end{align}
Here, $N$ denotes the number of electrons. 
We can think
of $\mu$ as a set of distinct integers that specify
the occupied spin orbitals, i.e.
\begin{align}
    \mu = (p^1, p^2, \ldots, p^N).
\end{align}
This is not an occupation number vector
in the sense of Helgaker et al.,\cite{helgakerMolecularElectronicstructureTheory2000}
but it contains the same information.
The time-derivative of
$\ket{\mu}$ is evaluated using the product rule:
\begin{align}
    \ket{\dot{\mu}} = \sum_{l=1}^{N} \left( \, \prod_{k < l} \creasuper{p}{k} \right) \creasuperdot{p}{l} \left( \, \prod_{k > l} \creasuper{p}{k} \right) \ket{\mathrm{vac}}.
\end{align}
Now, $\{ \crea{p}, \creadot{q} \} = 0$, so we can move $\creasuperdot{p}{l}$ all the way to the left in each term
by changing the sign $l - 1$ times, i.e.
\begin{align}
    \ket{\dot{\mu}} = \sum_{l=1}^{N} (-1)^{l-1} \, \creasuperdot{p}{l} \left( \, \prod_{k \neq l} \creasuper{p}{k} \right) \ket{\mathrm{vac}}.
\end{align}
Next, we insert
\begin{align} \label{eq:clever_1}
    1 = \{ \annisuper{p}{l}, \creasuper{p}{l} \} = \annisuper{p}{l} \creasuper{p}{l} + \creasuper{p}{l} \annisuper{p}{l}
\end{align}
to the right of $\creasuperdot{p}{l}$ and note that $\{ \annisuper{p}{l}, \creasuper{p}{k} \} = 0$ for $l \neq k$.
We can thus move $\annisuper{p}{l}$ in the second term of Eq.~\eqref{eq:clever_1} all the way to right
(under suitable sign changes), where it annihilates the vacuum. Hence, only the first term survives:
\begin{align}
    \ket{\dot{\mu}} = \sum_{l=1}^{N} (-1)^{l-1} \, \creasuperdot{p}{l} \annisuper{p}{l} \creasuper{p}{l} \left( \, \prod_{k \neq l} \creasuper{p}{k} \right) \ket{\mathrm{vac}}.
\end{align}
Finally, $\creasuper{p}{l}$ is moved to the $l$th slot in the product by changing the sign $l - 1$ times.
The two factors of $(-1)^{l-1}$ cancel, leaving us with
\begin{align}
    \ket{\dot{\mu}} 
    &= \sum_{l=1}^{N}  \creasuperdot{p}{l} \annisuper{p}{l}  \left( \, \prod_{k=1}^{N} \creasuper{p}{k} \right) \ket{\mathrm{vac}} \nn
    &= \sum_{l=1}^{N}  \creasuperdot{p}{l} \annisuper{p}{l}  \ket{\mu} \nn
    &= \sum_{p}        \creadot{p} \anni{p} \ket{\mu}.
\end{align}
In the last step we have added terms for each of the active orbitals that are not present in $\ket{\mu}$. 
These terms vanish, since the annihilator
$\anni{p}$ can be moved all the way to right for $p \notin \mu$. We now have an expression that does not refer to the specific orbitals
in $\ket{\mu}$, so it must hold for all $\ket{\mu}$. We thus write
\begin{align} \label{eq:time_derivative_ket_determinant}
    \ket{\dot{\mu}} = D \ket{\mu}, \quad D = \sum_{p} \creadot{p} \anni{p}
\end{align}
with the sum running over all active orbitals. For a bra Slater determinant, the same kind of proof yields
\begin{align} \label{eq:time_derivative_bra_determinant}
    \bra{\dot{\tilde{\mu}}} = \bra{\tilde{\mu}} \sum_{p} \crea{p} \annidot{p}.
\end{align}
So far, these results only hold for single determinants, which is not particularly useful in itself.
However, we can easily apply an active-space resolution of identity to the bra and ket states
(or, indeed, any states contained in the active space) to get the following complete
expansions:
\begin{subequations} \label{eq:FCI_expansion}
    \begin{alignat}{2}
        \ket{\Psi} 
        &= \sum_{\mu} \ket{\mu} \! \braket{\tilde{\mu} | \Psi} 
        &&\equiv \sum_{\mu} c_{\mu} \ket{\mu}, \\
        \bra{\tilde{\Psi}}
        &= \sum_{\mu} \braket{\tilde{\Psi} | \mu} \! \bra{\tilde{\mu}}
        &&\equiv  \sum_{\mu} \tilde{c}_{\mu} \bra{\tilde{\mu}}.
    \end{alignat}
\end{subequations}
Given that the basis is biorthogonal, the coefficients $c_{\mu}$ and $\tilde{c}_{\mu}$ can be evaluated
using only the fundamental anti-commutators (or, equivalently, Wick's theorem).
They are consequently independent of the orbitals as such and depend only on the correlation parameters $\bm{\alpha}$.
The time derivative term of the Lagrangian now reads
\begin{align}
    i \elm{\tilde{\Psi}}{ \partial_t }{\Psi}
    &= i \sum_{\mu} \bra{\tilde{\Psi}} \left( \smallddt c_{\mu} \ket{\mu} \right) \nn
    &= i \sum_{\mu} \bra{\tilde{\Psi}} \left( \dot{c}_{\mu} \ket{\mu} + c_{\mu} \ket{\dot{\mu}}  \right) \nn
    &= i \sum_{\mu} \bra{\tilde{\Psi}} \left( \sum_{j} \dot{\alpha}_j \pdv{c_\mu}{\alpha_j} \ket{\mu} + c_{\mu} D \ket{\mu}  \right) \nn
    &= i \sum_{j} \dot{\alpha}_j \bigbraket{\tilde{\Psi}}{\pdv{\Psi}{\alpha_j}} + i \elm{\tilde{\Psi}}{ D }{\Psi},
\end{align}
and the full Lagrangian becomes
\begin{align} \label{eq:Lagrangian_I_and_H_prime}
    \mathcal{L} 
    &= \elm{\tilde{\Psi}}{(i \partial_t - H)}{\Psi} \nn 
    &= i \sum_{j} \dot{\alpha}_j \bigbraket{\tilde{\Psi}}{\pdv{\Psi}{\alpha_j}} 
    - \elm{\tilde{\Psi}}{(H - iD)}{\Psi} \nn
    &\equiv \mathcal{I} (\bm{\alpha}, \dot{\bm{\alpha}}) - \mathcal{H}'(\bm{\alpha}, \tilde{\bm{\varphi}}, \bm{\varphi}, \dot{\bm{\varphi}}).
\end{align}

We will also need the variation of bra and ket determinants, but since
the (first-order) variation satisfies the product rule (Leibniz rule) just like
the time derivative, the proofs are identical to those leading to 
Eqs.~\eqref{eq:time_derivative_ket_determinant} and \eqref{eq:time_derivative_bra_determinant}
(the time derivative is, in fact,
an allowed variation). The result is simply
\begin{subequations} \label{eq:variation_of_mu_and_mu_tilde}
    \begin{align}
        \ket{\delta \mu}         &= \sum_{p} (\creavar{p}) \anni{p} \ket{\mu} \\
        \bra{\delta \tilde{\mu}} &= \bra{\tilde{\mu}} \sum_{p} \crea{p} (\annivar{p}).
    \end{align}
\end{subequations}
It is useful at this point to consider what the allowed
orbital variations look like. The variations should be
arbitrary under the constraint that they
conserve biorthogonality, i.e. the overlap
$\braket{\phibra{p} | \phiket{q}} = \delta_{pq}$
should be conserved:
\begin{align}
    0 = \delta \braket{\phibra{p} | \phiket{q}} = 
    \braket{\phibravar{p} | \phiket{q}} + \braket{\phibra{p} | \phiketvar{q}}.
\end{align}
Thus,
\begin{subequations} \label{eq:bra_ket_variation_link}
    \begin{align}
        \braket{\phibra{p} | \phiketvar{q}} &= +\epsilon_{pq} \\
        \braket{\phibravar{p} | \phiket{q}} &= -\epsilon_{pq},
    \end{align}
\end{subequations}
where $\epsilon_{pq}$ is an arbitrary scalar.
Equations~\eqref{eq:bra_ket_variation_link} show very clearly how the
variations of the bra and ket orbitals are linked by the biorthogonality
constraints.
This link can be utilized by
introducing the projector onto the active single-particle space,
\begin{align} \label{eq:P_proj_def}
    P = \sum_{p}  \ket{\phiket{p}} \! \bra{\phibra{p}},
\end{align}
and the projector onto the complement of the active space
(the secondary space),
\begin{align} \label{eq:Q_proj_def}
    Q = 1 - P.
\end{align}
We note that the secondary space need not, formally speaking, be finite dimensional.
% The precise nature of the secondary space is in some sense defined by
% the identity operator in Eq.~\eqref{eq:Q_proj_def}. Specifying what
% is meant by this operator uniquely specifies the secondary space;
% see e.g. Eq.~\eqref{eq:Q_proj_matrix}. 
By definition, we have
\begin{align}
    1 = P + Q
\end{align}
so that
\begin{align} \label{eq:general_phiket_variation}
    \ket{\phiketvar{q}} 
    &= (P + Q) \ket{\phiketvar{q}} \nn
    &= \sum_{p}  \ket{\phiket{p}} \! \braket{{\phibra{p}} | \phiketvar{q}} + Q \ket{\phiketvar{q}} \nn
    &\equiv \sum_{p} \ket{\phiket{p}} \epsilon_{pq} + \ket{\omega_q}.
\end{align}
For the bra orbitals we write
\begin{align} \label{eq:general_phibra_variation}
    \bra{\phibravar{p}} 
    &= \bra{\phibravar{p}} (P + Q) \nn
    &= \sum_{q} \braket{\phibravar{p} | \phiket{q}} \! \bra{\phibra{q}}
    + \bra{\phibravar{p}} Q  \nn
    &\equiv
    \sum_{q} (-\epsilon_{pq}) \bra{\phibra{q}} + \bra{\tilde{\omega}_p}.
\end{align}
We have now parameterized the allowed orbital
variations
in terms of the arbitrary and independent scalars $\epsilon_{pq}$ 
as well as the functions $\ket{\omega_q}$ and $\bra{\tilde{\omega}_p}$,
which satisfy
$\ket{\omega_q} = Q \ket{\omega_q} $ and
$\bra{\tilde{\omega}_p} = \bra{\tilde{\omega}_p} Q$, but are otherwise
arbitrary. While the
$P$-space variations are linked by
the $\epsilon_{pq}$, we stress that the $Q$-space variations $\ket{\omega_q}$ and $\bra{\tilde{\omega}_p}$
are completely independent from each other and from the $\epsilon_{pq}$. We are thus allowed
to perform the $P$-space variations, the $Q$-space ket variations 
and the $Q$-space bra variations separately.
First, we consider the $P$-space variations by setting
\begin{subequations} \label{eq:P_space_variations_pq}
    \begin{align} 
        \ket{\phiketvar{q}} &= \sum_{p} \ket{\phiket{p}} \epsilon_{pq}, \\
        \bra{\phibravar{p}} &= \sum_{q} (-\epsilon_{pq}) \bra{\phibra{q}}.
    \end{align}
\end{subequations}
% for each separate orbital pair $p,q$ (i.e. $\epsilon_{\bar{p} \bar{q}} = 0$ for $\bar{p}, \bar{q} \neq p, q$). 
% just as the $P$-space variations are done one orbital pair at a time.
Rather than using the first-quantized language of Eq.~\eqref{eq:P_space_variations_pq} we
write
\begin{subequations} \label{eq:P_space_variations_pq_SQ}
    \begin{align}
        \creavar{q} &= \sum_{p} \crea{p} \epsilon_{pq}, \\
        \annivar{p} &= \sum_{q} (-\epsilon_{pq}) \anni{q}
    \end{align}
\end{subequations}
and substitute this into Eqs.~\eqref{eq:variation_of_mu_and_mu_tilde}:
\begin{subequations} \label{eq:variation_of_mu_and_mu_tilde_pq}
    \begin{gather}
        \ket{\delta \mu} 
        = \sum_{pq} \epsilon_{pq} \, \crea{p} \anni{q} \ket{\mu}          
        = \sum_{pq} \epsilon_{pq} \, \Eplain{p}{q} \ket{\mu}  , \\
        \bra{\delta \tilde{\mu}} 
        = \sum_{pq} (-\epsilon_{pq}) \bra{\tilde{\mu}} \crea{p} \anni{q}  
        = \sum_{pq} (-\epsilon_{pq}) \bra{\tilde{\mu}} \Eplain{p}{q} .
    \end{gather}
\end{subequations}
Now, the $\epsilon_{pq}$ are independent and arbitrary, so 
we could choose a single index pair $\bar{p}, \bar{q}$ 
and set $\epsilon_{pq} = 0$ for $p,q \neq \bar{p}, \bar{q}$. Repeating
this for all pairs $\bar{p}, \bar{q}$ covers all allowed $P$-space variations and
yields the correct result (indeed, this is the approach taken by Kvaal\cite{kvaalInitioQuantumDynamics2012}).
We will, however, keep the summation over $p,q$ since this allows easy translation
to the orthogonal case where the $\epsilon_{pq}$ are not all independent.

As it stands, Eqs.~\eqref{eq:variation_of_mu_and_mu_tilde_pq} holds for single determinants. In order to get results that hold for the bra and ket states
(or, indeed, any states contained in the active space) we use the expansions in
Eqs.~\eqref{eq:FCI_expansion} and apply Eqs.~\eqref{eq:variation_of_mu_and_mu_tilde_pq} to each determinant in the sums.
This yields
\begin{subequations} \label{eq:variation_of_Psi_and_Psi_tilde_pq}
    \begin{gather}
        \ket{\delta \Psi}         = \sum_{pq} \epsilon_{pq} \,  \Eplain{p}{q} \ket{\Psi}  , \\
        \bra{\delta \tilde{\Psi}} = \sum_{pq} (-\epsilon_{pq}) \bra{\tilde{\Psi}} \Eplain{p}{q}
    \end{gather}
\end{subequations}
for orbital variations of the form given by Eqs.~\eqref{eq:P_space_variations_pq_SQ}.
Generally, we have
\begin{align}
    \delta \elm{\tilde{\Psi}}{A}{\Psi}
    &= \elm{\delta \tilde{\Psi}}{A}{\Psi} + \elm{\tilde{\Psi}}{A}{\delta \Psi} + \elm{\tilde{\Psi}}{(\delta A)}{\Psi} \nn
    &= \sum_{pq} \epsilon_{pq} \elm{\tilde{\Psi}}{[A, \Eplain{p}{q}] }{\Psi} + \elm{\tilde{\Psi}}{(\delta A)}{\Psi},
\end{align}
where $A$ is any operator that may depend on the orbitals. The Hamiltonian as such does not depend on
the orbitals, while
\begin{align}
    \delta D 
    &= \delta \sum_{r} \creadot{r} \anni{r} \nn
    &= \sum_{q} (\delta \creadot{q}) \anni{q} + \sum_{p} \creadot{p} (\annivar{p}) \nn
    &= \sum_{q} (\tfrac{\mathrm{d}}{\mathrm{d} t} \creavar{q}) \anni{q} + \sum_{p} \creadot{p} (\annivar{p}) \nn
    &= \sum_{pq} (\tfrac{\mathrm{d}}{\mathrm{d} t} \crea{p} \epsilon_{pq}) \anni{q} + \sum_{pq} \creadot{p} (-\epsilon_{pq}) \anni{q} \nn
    &= \sum_{pq} \left( \dot{\epsilon}_{pq} \crea{p} \anni{q} + \epsilon_{pq} \creadot{p} \anni{q} - \epsilon_{pq} \creadot{p} \anni{q}  \right) \nn
    % % &= \sum_{r} \big[ (\delta \creadot{r}) \anni{r} + \creadot{r} (\annivar{r}) \big] \nn
    % &= \sum_{r} \Big[ \! \left(\tfrac{\mathrm{d}}{\mathrm{d} t} \creavar{r} \right) \anni{r} + \creadot{r} (\annivar{r}) \Big] \nn
    % &= \left(\tfrac{\mathrm{d}}{\mathrm{d} t} \crea{p} \epsilon_{pq} \right) \anni{q} + \creadot{p} \anni{q} (-\epsilon_{pq}) \nn
    % &= \left( \dot{\epsilon}_{pq} \crea{p} \anni{q} + \epsilon_{pq} \creadot{p} \anni{q} \right) - \epsilon_{pq} \creadot{p} \anni{q} \nn
    &= \sum_{pq} \dot{\epsilon}_{pq} \crea{p} \anni{q} \nn
    &= \sum_{pq} \dot{\epsilon}_{pq} \Eplain{p}{q}.
\end{align}
We have used the fact that time derivatives and first-order variations commute.
Noting that the function $\mathcal{I}$ in Eq.~\eqref{eq:Lagrangian_I_and_H_prime} does not depend on the orbitals,
we compute the variation in $\mathcal{S}$ as
\begin{align}
    \delta{S} 
    &= \int_{t_0}^{t_1} \delta \elm{\tilde{\Psi}}{(iD - H)}{\Psi} \dd{t} \nn
    &= \sum_{pq} \int_{t_0}^{t_1} \left( \epsilon_{pq} \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi} + i \elm{\tilde{\Psi}}{(\delta D)}{\Psi} \right) \dd{t} \nn 
    &= \sum_{pq} \int_{t_0}^{t_1} \left( \epsilon_{pq} \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi} + i \dot{\epsilon}_{pq} \elm{\tilde{\Psi}}{\Eplain{p}{q}}{\Psi} \right) \dd{t} \nn 
    &= \sum_{pq} \int_{t_0}^{t_1} \left( \epsilon_{pq} \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi} + i \dot{\epsilon}_{pq} \rho_{qp} \right) \dd{t} \nn 
    &= \sum_{pq} \int_{t_0}^{t_1} \epsilon_{pq} \left( \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi} - i \dot{\rho}_{qp} \right) \dd{t},  \label{eq:P_space_variation_biorthogonal}
\end{align}
where we have used integration by parts on the second term (the boundary term vanishes since the variations are fixed at $t_0$ and $t_1$).
Requiring $\delta S = 0$ for arbitrary $\epsilon_{pq}$ implies
\begin{align}
    \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi} = i \dot{\rho}_{qp}
\end{align}
for each index pair $p,q$.
The operator $D$ appears inside a matrix element, so we are free to
substitute
\begin{align}
    D \rightarrow D_0 
    = \Pi D \Pi 
    = \sum_{rs} \braket{\phibra{r} | \phiketdot{s}} \Eplain{r}{s}
    = \sum_{rs} \eta_{rs} \Eplain{r}{s}.
\end{align}
This yields a set of linear equations for the $\eta_{rs}$:
\begin{align}
    i \sum_{rs} \elm{\tilde{\Psi}}{[\Eplain{r}{s}, \Eplain{p}{q}]}{\Psi} \eta_{rs} = i \dot{\rho}_{qp} + \elm{\tilde{\Psi}}{[H, E_{pq}]}{\Psi}.
\end{align}
We now turn to the $Q$-space variations. For this purpose,
it is convenient to write the Lagrangian as
\begin{align} \label{eq:Lagrangian_for_Q_space_variation}
    \mathcal{L} 
    &= \mathcal{I} + \elm{\tilde{\Psi}}{(iD - H)}{\Psi} \nn
    &= \mathcal{I} + \sum_{pq} (i \eta_{pq} - h_{pq}) \rho_{qp} - \frac{1}{2} \sum_{pqrs} u_{pqrs} \rho_{rspq} \nn
    &= \mathcal{I} +
    \sum_{pq} \elm{\phibra{p}}{(i \partial_t - h)}{\phiket{q}} \rho_{qp} 
    - \frac{1}{2} \sum_{pqrs} \elm{\phibra{p} \phibra{q}}{u}{\phiket{r} \phiket{s}} \rho_{rspq}.
\end{align}
We start by varying a single bra orbital, i.e.
\begin{subequations}
    \begin{gather}
        \bra{\phibravar{\bar{p}}} = \bra{\tilde{\omega}_{\bar{p}}} = \bra{\tilde{\omega}_{\bar{p}}} Q, \\
        \bra{\phibravar{p}} = 0, \quad p \neq \bar{p}.
    \end{gather}
\end{subequations}
The densities and the functional $\mathcal{I}$ can be evaluated using the anti-commutation relations (or Wick's theorem), so they do not
depend on the orbitals. The variation of the action thus reads
\begin{align} \label{eq:Q_space_variation_bra}
    \delta S 
    &= 
    \begin{multlined}[t]
        \int_{t_0}^{t_1}
        \bigg[
            \sum_{pq} \elm{\phibravar{p}}{(i \partial_t - h)}{\phiket{q}} \rho_{qp} 
            - \frac{1}{2} \sum_{pqrs} \elm{(\phibravar{p}) \phibra{q}}{u}{\phiket{r} \phiket{s}} \rho_{rspq}  \\
            - \frac{1}{2} \sum_{pqrs} \elm{\phibra{q} (\phibravar{p})}{u}{\phiket{s} \phiket{r}} \rho_{srqp} \,
        \bigg] \dd{t} 
    \end{multlined} \nn
    &= 
    \begin{multlined}[t]
        \int_{t_0}^{t_1}
        \bigg[
            \sum_{q} \elm{\tilde{\omega}_{\bar{p}}}{(i \partial_t - h)}{\phiket{q}} \rho_{q\bar{p}} 
            - \frac{1}{2} \sum_{qrs} \elm{\tilde{\omega}_{\bar{p}} \, \phibra{q}}{u}{\phiket{r} \phiket{s}} \rho_{rs\bar{p}q} \\
            - \frac{1}{2} \sum_{qrs} \elm{\phibra{q} \, \tilde{\omega}_{\bar{p}}}{u}{\phiket{s} \phiket{r}} \rho_{srq\bar{p}} \,
        \bigg] \dd{t} 
    \end{multlined} \nn
    &=
    \int_{t_0}^{t_1}
    \bigg[
        \sum_{q} \elm{\tilde{\omega}_{\bar{p}}}{(i \partial_t - h)}{\phiket{q}} \rho_{q\bar{p}}
        - \sum_{qrs} \elm{\tilde{\omega}_{\bar{p}} \, \phibra{q}}{u}{\phiket{r} \phiket{s}} \rho_{rs\bar{p}q}
    \bigg] \dd{t} \nn
    &=
    \int_{t_0}^{t_1}
    \bigg[
        \sum_{q} \elm{\tilde{\omega}_{\bar{p}}}{(i \partial_t - h)}{\phiket{q}} \rho_{q\bar{p}}
        - \sum_{qrs} \elm{\tilde{\omega}_{\bar{p}}}{ W_{qs} }{\phiket{r}} \rho_{rs\bar{p}q}
    \bigg] \dd{t}.
\end{align}
The mean-field operator is defined through
\begin{align}
    \elm{\tilde{\omega}_{\bar{p}}}{ W_{qs} }{\phiket{r}}
    &= \int \tilde{\omega}_{\bar{p}} (\mathbf{x}) W_{qs} (\mathbf{x}) \phiket{r} (\mathbf{x}) \dd{\mathbf{x}} \nn
    &= \int \tilde{\omega}_{\bar{p}} (\mathbf{x}) 
    \left[\int \phibra{q} (\mathbf{y}) u(\mathbf{x}, \mathbf{y}) \phibra{s} (\mathbf{y}) \dd{\mathbf{y}}\right]
    \phiket{r} (\mathbf{x}) \dd{\mathbf{x}} \nn 
    &= \int \int 
    \tilde{\omega}_{\bar{p}} (\mathbf{x}) 
    \phibra{q} (\mathbf{y}) 
    u(\mathbf{x}, \mathbf{y}) 
    \phiket{r} (\mathbf{x}) 
    \phibra{s} (\mathbf{y})
    \dd{\mathbf{x}} \dd{\mathbf{y}} \nn
    &= \elm{\tilde{\omega}_{\bar{p}} \, \phibra{q}}{u}{\phiket{r} \phiket{s}}.
\end{align}
The function $\bra{\tilde{\omega}_{\bar{p}}} = \bra{\tilde{\omega}_{\bar{p}}} Q$ is
arbitrary so $\delta S = 0$ if and only if
\begin{align}
    \sum_{q} Q (i \partial_t - h) \ket{\phiket{q}} \rho_{q\bar{p}}
    = \sum_{qrs} Q W_{qs} \ket{\phiket{r}} \rho_{rs\bar{p}q}
\end{align}
or, equivalently,
\begin{align}
    i Q \sum_{q} \ket{\phiketdot{q}} \rho_{q\bar{p}}
    = 
    Q \bigg[ \sum_{q} h \ket{\phiket{q}} \rho_{q\bar{p}}
    + \sum_{qrs} W_{qs} \ket{\phiket{r}} \rho_{rs\bar{p}q} \bigg].
\end{align}
Taking the one-bode density to be invertible, we finally get
\begin{align}
    i Q \ket{\phiketdot{p}}
    = 
    Q \bigg[ h \ket{\phiket{p}}
    + \sum_{\bar{p}qrs} W_{qs} \ket{\phiket{r}} \rho_{rs\bar{p}q} \, (\bm{\rho}^{-1})_{\bar{p}p} \bigg],
\end{align}
which agrees with the $Q$-space term of Eq.~\eqref{eq:phiket_dot} after renaming summation indices.
The $Q$-space term of Eq.~\eqref{eq:phibra_dot} is derived in a very similar manner by setting
\begin{subequations}
    \begin{gather}
        \ket{\phiketvar{\bar{p}}} = \ket{\omega_{\bar{p}}} = Q \ket{\omega_{\bar{p}}}, \\
        \ket{\phiketvar{p}}  = 0, \quad p \neq \bar{p}.
    \end{gather}
\end{subequations}
When doing the derivation, one needs to use integration by parts 
to move the time derivative in Eq.~\eqref{eq:Lagrangian_for_Q_space_variation}
to the bra side. For later reference, the variation takes the form
\begin{align} \label{eq:Q_space_variation_ket}
    \delta S 
    &=
    -\int_{t_0}^{t_1}
    \bigg[
        \sum_{q} \big( i \braket{\phibradot{q} | \omega_{\bar{p}}} + \elm{\phibra{q}}{h}{\omega_{\bar{p}}}
        \big) \rho_{\bar{p}q}
        + \sum_{qrs} \elm{\phibra{r}}{ W_{sq} }{\omega_{\bar{p}}} \rho_{\bar{p}qrs}
    \bigg] \dd{t}.
\end{align}


\subsection{Orthogonal case}
When the active basis is orthogonal we write $\bra{\phibra{p}} = \bra{\phiket{p}}$
and $\braket{\phiket{p} | \phiket{q}} = \delta_{pq}$. In order for this overlap
to be conserved we must have
\begin{subequations}
    \begin{gather}
        0 
        = \delta \braket{\phiket{p} | \phiket{q}} 
        = \braket{\delta \phiket{p} | \phiket{q}}
        + \braket{\phiket{p} | \delta \phiket{q}}, \\
        0 
        = \smallddt \braket{\phiket{p} | \phiket{q}} 
        = \braket{\phiketdot{p} | \phiket{q}}
        + \braket{\phiket{p} | \phiketdot{q}}.
    \end{gather}
\end{subequations}
As in the biorthogonal case, this implies
\begin{subequations}
    \begin{align}
        \braket{\phiket{p} | \delta \phiket{q}} &= +\epsilon_{pq}, \\
        \braket{\delta \phiket{p} | \phiket{q}} &= -\epsilon_{pq}
    \end{align}
\end{subequations}
for the variation and
\begin{subequations}
    \begin{align}
        \braket{\phiket{p} | \phiketdot{q}} &= +\eta_{pq}, \\
        \braket{\phiketdot{p} | \phiket{q}} &= -\eta_{pq}
    \end{align}
\end{subequations}
for the time derivative. In addition, orthogonality implies
\begin{subequations}
    \begin{align}
        \epsilon_{pq}^{*} = -\epsilon_{qp}, \\
        \eta_{pq}^{*}     = -\eta_{qp},
    \end{align}
\end{subequations}
so that $\bm{\epsilon}$ and $\bm{\eta}$ are anti-Hermitian (skew-Hermitian) matrices.
Specifically, the scalars $\epsilon_{pq}$ and $\eta_{pq}$ are not all independent.

A parameterization based on orthogonal orbitals is not holomorphic (complex analytic)
since it involves complex conjugation (which is not a holomorphic mapping):
The bra orbitals are simply the complex conjugate of the ket orbitals. This is
not consistent with the use of a complex-valued action, as mentioned by Kvaal.\cite{kvaalInitioQuantumDynamics2012} 
Instead, we must resort to the real part of the action functional:
\begin{align}
    \mathrm{Re}(\mathcal{S}) = \tfrac{1}{2} (\mathcal{S} + \mathcal{S}^*).
\end{align}
Generally speaking, $\mathcal{S}$ and $\mathrm{Re}(\mathcal{S})$ depend on a set of
complex scalars (correlation parameters) and a set of complex functions (orbitals).
We are free to consider the real and imaginary parts separately, so that the independent parameters are
$\mathbf{x}$ and $\mathbf{y}$. Alternatively, we can take $\mathbf{z} = \mathbf{x} + i \mathbf{y}$ 
and $\mathbf{z}^* = \mathbf{x} - i \mathbf{y}$ as the independent parameters.

If we perform the variation with respect to $\mathbf{z}$
we get
\begin{align}
    \delta_{\mathbf{z}} \mathrm{Re}(\mathcal{S}) 
    = \tfrac{1}{2} (\delta_{\mathbf{z}} \mathcal{S} + \delta_{\mathbf{z}} (\mathcal{S}^*))
    = \tfrac{1}{2} (\delta_{\mathbf{z}} \mathcal{S} + (\delta_{\mathbf{z}^*} \mathcal{S})^*).
\end{align}
If the bra and ket states are holomorphic in $\mathbf{z}$, then
$\mathcal{S}$ has no dependence on $\mathbf{z}^*$ and $\delta_{\mathbf{z}^*} \mathcal{S} = 0$.
In that case, the real-action bivariational principle simplifies to the complex-action principle.
(this happens, e.g., for the amplitudes in ordinary and extended coupled cluster). In contrast,
$\mathcal{S}$ is non-holomorphic in the orbitals, so such a reduction does not occur in the orbital equations.
Note that the variation with respect to $\mathbf{z}^*$ is
\begin{align}
    \delta_{\mathbf{z}^*} \mathrm{Re}(\mathcal{S}) 
    = \tfrac{1}{2} (\delta_{\mathbf{z}^*} \mathcal{S} + \delta_{\mathbf{z}^*} (\mathcal{S}^*))
    = \tfrac{1}{2} (\delta_{\mathbf{z}^*} \mathcal{S} + (\delta_{\mathbf{z}} \mathcal{S})^*)
    = (\delta_{\mathbf{z}} \mathrm{Re}(\mathcal{S}))^*,
\end{align}
i.e. the complex conjugate of the variation with respect to $\mathbf{z}$. This ensures
that variations with respect to $\mathbf{z}$ and $\mathbf{z}^*$ yield the same equations,
as they should. Although this seems like an obvious thing, it only happens because the
action is real. 

We have seen that $P$-space orbital variations are linked by the biorthogonality constraint
meaning we should vary $\bm{\varphi}$ and $\bm{\varphi}^*$ at the same time
(as in the biorthogonal case, these variations are parameterized by the scalars $\epsilon_{pq}$).
More generally, we can consider what happens when we vary $\mathbf{z}$ and $\mathbf{z}^*$ at
the same time (this is always allowed, but usually not required, unless there are
some additional constraints):
\begin{align}
    \delta_{\mathbf{z},\mathbf{z}^*} \mathrm{Re}(\mathcal{S}) 
    = \tfrac{1}{2} (\delta_{\mathbf{z},\mathbf{z}^*} \mathcal{S} + \delta_{\mathbf{z},\mathbf{z}^*} (\mathcal{S}^*))
    = \tfrac{1}{2} (\delta_{\mathbf{z},\mathbf{z}^*} \mathcal{S} + (\delta_{\mathbf{z},\mathbf{z}^*} \mathcal{S})^*)
    = \mathrm{Re}(\delta_{\mathbf{z}, \mathbf{z}^*}  \mathcal{S}).
\end{align}
This is useful since the computation of $\delta_{\bm{\varphi}, \bm{\varphi}^*}  \mathcal{S}$
is exactly analogous to that of $\delta_{\bm{\varphi}, \tilde{\bm{\varphi}}}  \mathcal{S}$.
We can, in other words, simply take the real part of Eq.~\eqref{eq:P_space_variation_biorthogonal}
(it is, of course, also possible to derive the variation explicitly at the expense of a few extra steps).
Dropping the subscripts on $\delta_{\bm{\varphi}, \bm{\varphi}^*}$ and defining
\begin{align}
    X_{qp} = \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi} - i \dot{\rho}_{qp},
\end{align}
this reads as
\begin{align}
    2 \delta \mathrm{Re}(\mathcal{S}) 
    &= \sum_{pq} \int_{t_0}^{t_1}  (\epsilon_{pq} X_{qp} + \epsilon_{pq}^* X_{qp}^* ) \dd{t} \nn
    &= \sum_{pq} \int_{t_0}^{t_1}  (\epsilon_{pq} X_{qp} + \epsilon_{qp}^* X_{pq}^* ) \dd{t} \nn
    &= \sum_{pq} \int_{t_0}^{t_1} \epsilon_{pq} ( X_{qp} - X_{pq}^* ) \dd{t},
\end{align}
where we have simply renamed summation indices and used $\epsilon_{qp}^* = - \epsilon_{pq}$.
We conclude that the orbital equations for the orthogonal case are
\begin{align}
    X_{qp} - X_{pq}^* = 0 \qqtext{or} \mathbb{A}(\mathbf{X}) = 0,
\end{align}
where $\mathbb{A}(\,\cdot\,)$ denotes the anti-Hermitian part.
Writing the equations in more detail, we get
\begin{gather}
    % \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi} - \elm{\tilde{\Psi}}{[iD - H, E_{qp}]}{\Psi}^*
    % = i (\rho_{qp} + \rho_{pq}^*) \nn
    \elm{\tilde{\Psi}}{[iD, E_{pq}]}{\Psi} - \elm{\tilde{\Psi}}{[iD, E_{qp}]}{\Psi}^*
    = \elm{\tilde{\Psi}}{[H, E_{pq}]}{\Psi} - \elm{\tilde{\Psi}}{[H, E_{qp}]}{\Psi}^*
    + i (\dot{\rho}_{qp} + \dot{\rho}_{pq}^*).  \nonumber
\end{gather}
Expanding the operator $D$ and defining
\begin{align}
    f_{pq} = \elm{\tilde{\Psi}}{[H, E_{pq}]}{\Psi}
\end{align}
then leads to
\begin{align}
    \sum_{rs} \Big(
        i\elm{\tilde{\Psi}}{[E_{rs}, E_{pq}]}{\Psi}     \eta_{rs}
       +i\elm{\tilde{\Psi}}{[E_{rs}, E_{pq}]}{\Psi}^* \,\eta_{rs}^*
    \Big)
    = 
    (f_{pq} - f_{qp}^*) + i (\dot{\rho}_{qp} + \dot{\rho}_{pq}^*), \\
    i \sum_{rs} \Big(
        \elm{\tilde{\Psi}}{[E_{rs}, E_{pq}]}{\Psi} 
    -   \elm{\tilde{\Psi}}{[E_{sr}, E_{pq}]}{\Psi}^*
    \Big) \eta_{rs}
    = 
    (f_{pq} - f_{qp}^*) + i (\dot{\rho}_{qp} + \dot{\rho}_{pq}^*).
\end{align}
The second line simple uses $\eta_{rs}^* = -\eta_{sr}$ followed by renaming of summation indices.
The right-hand side involves the time derivative of the one-electron density matrix,
which depends on the $\eta_{rs}$:
\begin{align}
    i\dot{\rho}_{qp} 
    &= \sum_{i}  {\pdv{\rho_{qp}}{\alpha_i}} (i\dot{\alpha_i}) \nn
    &= \sum_{ij} {\pdv{\rho_{qp}}{\alpha_i}} (\mathbf{M}^{-1})_{ij} \pdv{\mathcal{H}'}{\alpha_j}.
\end{align}
The matrix $\mathbf{M}$ has elements
\begin{align}
    M_{ij} = \bigbraket{\pdv{\tilde{\Psi}}{\alpha_i}}{\pdv{\Psi}{\alpha_j}}
    - \bigbraket{\pdv{\tilde{\Psi}}{\alpha_j}}{\pdv{\Psi}{\alpha_i}}.
\end{align}
We now define
\begin{align}
    A_{i(pq)} = {\pdv{\rho_{qp}}{\alpha_i}} = \pdv{}{\alpha_j}  \elm{\tilde{\Psi}}{E_{pq}}{\Psi}, \quad
    h_j = \pdv{\mathcal{H}}{\alpha_j}
\end{align}
and compute
\begin{align}
    \pdv{\mathcal{H}'}{\alpha_j} 
    &= \pdv{}{\alpha_j} \elm{\tilde{\Psi}}{(H - iD)}{\Psi}  \nn
    &= h_j - i \sum_{rs} \pdv{}{\alpha_j}  \elm{\tilde{\Psi}}{E_{rs}}{\Psi} \eta_{rs} \nn
    &= h_j - i \sum_{rs} A_{j(rs)} \eta_{rs}
\end{align}
so that
\begin{align}
    i\dot{\rho}_{qp} = \sum_{ij}
    A_{i(pq)} (\mathbf{M}^{-1})_{ij}
    \Big(
        h_j - i \sum_{rs} A_{j(rs)} \eta_{rs}
    \Big).
\end{align}

For the $Q$-space equations we would like to compute 
\begin{align}
    \delta_{\bm{\varphi}^*} \mathrm{Re}(\mathcal{S}) 
    = \tfrac{1}{2} (\delta_{\bm{\varphi}^*} \mathcal{S} + (\delta_{\bm{\varphi}} \mathcal{S})^*).
\end{align}
This can be done directly, but we can in fact reuse the derivations from the biorthogonal case
by noting that $\delta_{\bm{\varphi}^*} \mathcal{S}$ is formally identical
to Eq.~\eqref{eq:Q_space_variation_bra} (which we might write as $\delta_{\tilde{\bm{\varphi}}} \mathcal{S}$),
while $\delta_{\bm{\varphi}} \mathcal{S}$ is formally identical to Eq.~\eqref{eq:Q_space_variation_ket}.
The phrase `formally identical' simply means that all steps in the derivations are the same;
the only difference is the absence of tildes on the bra orbitals and bra variations. 
Rearranging slightly, we thus have
\begin{subequations}
    \begin{align}
        \delta_{\bm{\varphi}^*} \mathcal{S} 
        &=
        +\int_{t_0}^{t_1}
        \bra{\omega_{\bar{p}}} Q
        \bigg[
            \sum_{q} \big[ i \ket{\phiketdot{q}} - h \ket{\phiket{q}} \mspace{-2mu} \big] \rho_{q\bar{p}}
            - \sum_{qrs} W_{qs} \ket{\phiket{r}} \rho_{rs\bar{p}q}
        \bigg] \dd{t}, \\
        \delta_{\bm{\varphi}} \mathcal{S}
        &=
        -\int_{t_0}^{t_1}
        \bigg[
            \sum_{q} \big[ i \bra{\phiketdot{q}} + \bra{\phiket{q}} h \, \big] \rho_{\bar{p}q}
            + \sum_{qrs} \bra{\phiket{r}} W_{sq} \, \rho_{\bar{p}qrs}
        \bigg] Q \ket{\omega_{\bar{p}}} \dd{t}
    \end{align}
\end{subequations}
and
\begin{align}
    \delta_{\bm{\varphi}^*} \mathrm{Re}(\mathcal{S})
    &= \tfrac{1}{2} (\delta_{\bm{\varphi}^*} \mathcal{S} + (\delta_{\bm{\varphi}} \mathcal{S})^*) \nn
    &=
    \frac{1}{2} \int_{t_0}^{t_1}
        \bra{\omega_{\bar{p}}} Q
        \bigg[
            \sum_{q} \big[ i \ket{\phiketdot{q}} - h \ket{\phiket{q}} \mspace{-2mu} \big] ( \rho_{q\bar{p}} + \rho_{\bar{p}q}^* )
            - \sum_{qrs} W_{qs} \ket{\phiket{r}} ( \rho_{rs\bar{p}q} + \rho_{\bar{p}qrs}^* )
        \bigg] \dd{t} \nn
    &\equiv
    \int_{t_0}^{t_1}
        \bra{\omega_{\bar{p}}} Q
        \bigg[
            \sum_{q} \big[ i \ket{\phiketdot{q}} - h \ket{\phiket{q}} \mspace{-2mu} \big] D_{q\bar{p}}
            - \sum_{qrs} W_{qs} \ket{\phiket{r}} P_{rs\bar{p}q}
        \bigg] \dd{t}
\end{align}
Since $\bra{\omega_{\bar{p}}} Q$ is arbitrary, $\delta_{\bm{\varphi}^*} \mathrm{Re}(\mathcal{S}) = 0$
if and only if
\begin{align}
    \sum_{q} i Q \ket{\phiketdot{q}} D_{q\bar{p}} 
    = Q \bigg[ \sum_{q} h \ket{\phiket{q}} D_{q\bar{p}}
    + \sum_{qrs} W_{qs} \ket{\phiket{r}} P_{rs\bar{p}q} \bigg].
\end{align}
Taking $\mathbf{D}$ to be invertible, we obtain the final equations of motion:
\begin{align}
    i Q \ket{\phiketdot{p}}
    = Q \bigg[ h \ket{\phiket{p}}
    + \sum_{\bar{p}qrs} W_{qs} \ket{\phiket{r}} P_{rs\bar{p}q} \, (\mathbf{D}^{-1})_{\bar{p} p} \bigg].
\end{align}

% we start by varying a single bra orbital, i.e.
% \begin{subequations}
%     \begin{gather}
%         \bra{\phiketvar{\bar{p}}} = \bra{\omega_{\bar{p}}} = \bra{\omega_{\bar{p}}} Q, \\
%         \bra{\phiketvar{p}} = 0, \quad p \neq \bar{p}.
%     \end{gather}
% \end{subequations}







% \begin{alignat}{4}  \label{eq:P_space_variation_orthogonal}
%     2 \delta \mathrm{Re}(\mathcal{S}) 
%     = &\sum_{pq} \int_{t_0}^{t_1} \epsilon_{pq}   \Big( \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi}   && {}-{} &&(i \dot{\rho}_{qp})   &&\Big) \dd{t} \nn
%     + &\sum_{pq} \int_{t_0}^{t_1} \epsilon_{pq}^* \Big( \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi}^* && {}-{} &&(i \dot{\rho}_{qp})^* &&\Big) \dd{t}, 
% \end{alignat}
% \begin{alignat}{2}  \label{eq:P_space_variation_orthogonal}
%     2 \delta \mathrm{Re}(\mathcal{S}) 
%     = &\sum_{pq} \int_{t_0}^{t_1} \epsilon_{pq}   \Big( \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi} - i \dot{\rho}_{qp} \Big)       &&\dd{t} \nn
%     + &\sum_{pq} \int_{t_0}^{t_1} \epsilon_{pq}^* \Big( \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi} - i \dot{\rho}_{qp} \Big)^{\!*} &&\dd{t} \nn
%     %%%
%     = &\sum_{pq} \int_{t_0}^{t_1} \epsilon_{pq}   \Big( \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi} - i \dot{\rho}_{qp} \Big)       &&\dd{t} \nn
%     + &\sum_{pq} \int_{t_0}^{t_1} \epsilon_{qp}^* \Big( \elm{\tilde{\Psi}}{[iD - H, E_{qp}]}{\Psi} - i \dot{\rho}_{pq} \Big)^{\!*} &&\dd{t} \nn
%     \equiv& \sum_{pq} \int_{t_0}^{t_1} (\epsilon_{pq}   X_{qp} + \epsilon_{qp}^* X_{pq}^*)   \dd{t},
% \end{alignat}
% \begin{align}  \label{eq:P_space_variation_orthogonal}
%     2 \delta \mathrm{Re}(\mathcal{S}) 
%     &=
%     \begin{multlined}[t]
%           \sum_{pq} \int_{t_0}^{t_1} \epsilon_{pq}   \Big( \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi}   - (i \dot{\rho}_{qp})   \Big) \dd{t} \\
%         + \sum_{pq} \int_{t_0}^{t_1} \epsilon_{pq}^* \Big( \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi}^* - (i \dot{\rho}_{qp})^* \Big) \dd{t}
%     \end{multlined} \nn
%     %%%
%     &=
%     \begin{multlined}[t]
%         \sum_{pq} \int_{t_0}^{t_1} \epsilon_{pq}   \Big( \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi}   - (i \dot{\rho}_{qp})   \Big) \dd{t} \\
%       + \sum_{pq} \int_{t_0}^{t_1} \epsilon_{qp}^* \Big( \elm{\tilde{\Psi}}{[iD - H, E_{qp}]}{\Psi}^* - (i \dot{\rho}_{pq})^* \Big) \dd{t}, 
%   \end{multlined}
% \end{align}
% where we have simply renamed summation indices after the second equality.
% Using $\epsilon_{qp}^* = - \epsilon_{pq}$ and collecting terms, we get
% \begin{align}
%     2 \delta \mathrm{Re}(\mathcal{S}) 
%     = &\sum_{pq} \int_{t_0}^{t_1} \epsilon_{pq}   \big( \elm{\tilde{\Psi}}{[iD - H, E_{pq}]}{\Psi} - i \dot{\rho}_{qp} \big)       \dd{t} \nn
%     - &\sum_{pq} \int_{t_0}^{t_1} \epsilon_{pq}   \big( \elm{\tilde{\Psi}}{[iD - H, E_{qp}]}{\Psi} - i \dot{\rho}_{pq} \big)^{\!*} \dd{t}, \nn
% \end{align}


% In contrast, the action is non-holomorphic in the orbitals, so we must consider both terms.
% We note, however, that
% \begin{align}
%     \mathbf{z} = \{ \bm{\varphi}^*, \bm{\varphi} \} = \{ \bm{\varphi}^*, \bm{\varphi} \}^* = \mathbf{z}^*.
% \end{align}
% This implies
% \begin{align}
%     \delta_{\{ \bm{\varphi}^*, \bm{\varphi} \}} \mathrm{Re}(\mathcal{S}) 
%     = \mathrm{Re}( \delta_{\{ \bm{\varphi}^*, \bm{\varphi} \}} (\mathcal{S})  )
% \end{align}
% or, more generally, that the variation and the complex conjugate commute if the
% variation is performed with respect to some parameters and the complex conjugate parameters at the same time.
% The steps needed for computing $\delta_{\{ \bm{\varphi}^*, \bm{\varphi} \}} (\mathcal{S})$ are identical
% to the ones we used for $\delta_{\{ \tilde{\bm{\varphi}}, \bm{\varphi} \}} (\mathcal{S})$.


% Second, we perform the
% $Q$-space ket variations,
% \begin{align}
%     \ket{\phiketvar{q}} = \ket{\omega_q},    
% \end{align}
% and, finally, the $Q$-space bra variations,
% \begin{align}
%     \bra{\phibravar{p}} = \bra{\tilde{\omega}_p}.
% \end{align}
% The $Q$-space variations are done one orbital at a time (keeping all other orbitals fixed).


\section{Further ideas}
\begin{itemize}
    \item Ground state in exponential parameterization?
    \item Detailed derivation of mean-field operators for vibrational case.
\end{itemize}

\newpage
\bibliography{bib/madsgh.bib}

\end{document}
