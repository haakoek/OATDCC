\documentclass[aip,jcp,preprint,superscriptaddress,nofootinbib]{revtex4-1}
\usepackage{silence}
\WarningFilter{revtex4-1}{Repair the float}
\renewcommand{\thefootnote}{\alph{footnote}}

\input{preamble/general.tex}
\input{preamble/local.tex}
\input{preamble/abbreviations.tex}


\newcommand{\au}{Department of Chemistry, Aarhus University, Langelandsgade 140, 8000 Aarhus C, Denmark}


\begin{document}

\title{Relating orbital and parameter equations}
\author{Mads Greisen HÃ¸jlund}
\email{madsgh@chem.au.dk}
\affiliation{\au}

\date{\today}
\maketitle

\tableofcontents
\newpage



\section{Notation} \label{sec:notation}

The Hamiltonian is written using physicist's notation for the integrals (which are not anti-symmetrized):
\begin{align}
    H = \sum_{pq} h_{pq} \crea{p} \anni{q} + \frac{1}{2} \sum_{pqrs} u_{pqrs} \crea{p} \crea{q} \anni{s} \anni{r}
\end{align}
\begin{align}
    h_{pq} 
    = \elm{\phibra{p}}{h}{\phiket{q}} 
    \equiv \int \phibra{p}(\mathbf{x}) h(\mathbf{x}) \phiket{q}(\mathbf{x}) \dd{\mathbf{x}}
\end{align}
\begin{align}
    u_{pqrs} 
    = \elm{\phibra{p} \phibra{q}}{u}{\phiket{r} \phiket{s}}
    \equiv \iint \phibra{p}(\mathbf{x}) \phibra{q}(\mathbf{y}) u(\mathbf{x}, \mathbf{y}) \phiket{r}(\mathbf{x}) \phiket{s}(\mathbf{y}) \dd{\mathbf{x}} \dd{\mathbf{y}}
\end{align}
Density matrices are defined as
\begin{align}
    \rho_{qp}   &= \elm{\tilde{\Psi}}{ \crea{p} \anni{q} }{\Psi}, \\
    \rho_{rspq} &= \elm{\tilde{\Psi}}{ \crea{p} \crea{q} \anni{s} \anni{r} }{\Psi}.
\end{align}
The two-electron integrals and densities have the following useful permutation symmetries:
\begin{align}
    u_{pqrs}    &= u_{qpsr}, \\
    \rho_{rspq} &= \rho_{srqp}.
\end{align}
In the following, we use $o,p,q,r,s$ to index active orbitals. In coupled cluster
theory, the active orbitals are additionally divided into reference/occupied orbitals ($i,j,\ldots$)
and virtual orbitals ($a,b,\ldots$).


\section{Converting orbital equations to parameter equations}
The orbital equations are formally identical for all orbital-adaptive methods.
Following Kvaal\cite{kvaalInitioQuantumDynamics2012} and Sato\cite{satoCommunicationTimedependentOptimized2018}, 
they take the appearance
\begin{align}
    i \ket{\phiketdot{p}} 
    = i \sum_{q} \ket{\phiket{q}} \eta_{qp}
    + Q \Big[
    h \ket{\phiket{p}} + \sum_{oqrs} W_{rs} \ket{\phiket{q}} P_{qsor} \, (\mathbf{D}^{-1})_{op}
    \Big], \label{eq:phiket_dot} \\
    i \bra{\phibradot{p}} 
    = -i \sum_{q} \eta_{pq} \bra{\phibra{q}} -
    \Big[
    \bra{\phibra{p}} h + \sum_{oqrs} (\mathbf{D}^{-1})_{po} \, P_{osqr}  \bra{\phibra{q}} W_{rs} 
    \Big] Q. \label{eq:phibra_dot}
\end{align}
The mean-field operator\cite{miyagiTimedependentRestrictedactivespaceSelfconsistentfield2013,satoTimedependentCompleteactivespaceSelfconsistentfield2013}
$W_{rs}$ is a multiplicative/local operator given by
\begin{align}
    W_{rs} (\mathbf{x}) = \int \phibra{r} (\mathbf{y}) u(\mathbf{x}, \mathbf{y}) \phiket{s} (\mathbf{y}) \dd{\mathbf{y}}.
\end{align}
Kvaal\cite{kvaalInitioQuantumDynamics2012} uses a slightly different notation, but the meaning should be the same. 
The secondary-space projector is given by
\begin{align}
    Q = 1 - \sum_{p} \ket{\phiket{p}} \! \bra{\phibra{p}}.
\end{align}
The definitions of the densities depend on whether biorthogonal\cite{kvaalInitioQuantumDynamics2012}
or orthogonal\cite{satoTimedependentCompleteactivespaceSelfconsistentfield2013} orbitals are used.
In the biorthogonal case, the plain one- and two-electron densities are used:
\begin{align}
    D_{qp}   &= \rho_{qp}, \\
    P_{rspq} &= \rho_{rspq}.
\end{align}
In the orthogonal case, the densities are Hermitianized according to
\begin{align}
    D_{qp}   &= \tfrac{1}{2} ( \rho_{qp}   + \rho_{pq}^*   ), \\
    P_{rspq} &= \tfrac{1}{2} ( \rho_{rspq} + \rho_{pqrs}^* ).
\end{align}
Having an orthogonal basis of course means $\bra{\phibra{p}} = \bra{\phiket{p}}$,
which implies $Q = Q^{\dagger}$ and $W_{rs}^* = W_{sr}$. Using these relations
and the Hermitianized densities one easily confirms that Eqs.~\eqref{eq:phiket_dot}
and \eqref{eq:phibra_dot} are simply each other's adjoint,
when the orbitals are orthogonal.

We now introduce an underlying/primitive basis that is indexed by greek subscripts and assumed to be biorthonormal.
The time-dependent, active orbitals are given in terms of this basis as
\begin{align}
    \ket{\phiket{p}} = \sum_{\alpha} \ket{\chiket{\alpha}} C_{\alpha p},         \label{eq:phi_ket_expansion} \\
    \bra{\phibra{p}} = \sum_{\alpha} \tilde{C}_{p \alpha} \bra{\chibra{\alpha}}, \label{eq:phi_bra_expansion}
\end{align}
with time-dependent coefficients. 
Using $N$ and $N_{\!\textsc{A}} \leq N$ to denote the number of primitive and active
basis functions, respectively, we have that
$\mathbf{C}$         is $N \times N_{\!\textsc{A}}$ (tall) and 
$\tilde{\mathbf{C}}$ is $N_{\!\textsc{A}} \times N$ (wide).
The primitive basis induces the following identity in
the one-particle space:
\begin{align}
    1 = \sum_{\beta} \ket{\chiket{\beta}} \! \bra{\chibra{\beta}} 
\end{align}
Inserting this identity into Eq.~\eqref{eq:phiket_dot} and projecting onto $\bra{\chibra{\alpha}}$ yields
\begin{multline}
    i \braket{\chibra{\alpha} | \phiketdot{p}} 
    = i \sum_{q} \braket{\chibra{\alpha} | \phiket{q}} \eta_{qp}
    + \sum_{\beta} \elm{\chibra{\alpha}}{Q}{\chiket{\beta}} \Big[
    \elm{\chibra{\beta}}{h}{\phiket{p}}
    + \sum_{oqrs}  \elm{\chibra{\beta}}{W_{rs}}{\phiket{q}} P_{qsor} \, (\mathbf{D}^{-1})_{op}
    \Big].
\end{multline}
Introducing matrix notation, this reads
\begin{align} \label{eq:C_dot}
    i \dot{\mathbf{C}} 
    &= i \mathbf{C} \bm{\eta} + 
    \mathbf{Q}  \big( \check{\mathbf{H}} + \check{\mathbf{F}} \mathbf{D}^{-1} \big) \nn
    &= i \mathbf{C} \bm{\eta} + 
    \mathbf{Q}  \big( \check{\mathbf{H}} \mathbf{D} + \check{\mathbf{F}} \big) \mathbf{D}^{-1} .
\end{align}
The secondary-space projector has matrix elements
\begin{align}
    Q_{\alpha \beta} 
    &= \elm{\chibra{\alpha}}{Q}{\chiket{\beta}} \nn
    &= \elm{\chibra{\alpha}}{(1 - P)}{\chiket{\beta}} \nn
    &= \braket{\chibra{\alpha} | \chiket{\beta}} - \sum_{p} \braket{\chibra{\alpha} | \phiket{p}} \braket{\phibra{p} | \chiket{\beta}}
\end{align}
or simply
\begin{align} \label{eq:Q_proj_matrix}
    \mathbf{Q} = \mathbf{1} - \mathbf{C} \tilde{\mathbf{C}}.
\end{align}
The matrices $\check{\mathbf{H}}$ and $\check{\mathbf{F}}$ contain
half-transformed one-electron integrals,
\begin{gather}
    \check{H}_{\beta p} = \elm{\chibra{\beta}}{h}{\phiket{p}} = h_{\beta p},
\end{gather}
and half-transformed mean-field elements,
\begin{align}
    \check{F}_{\beta o}
    &= \sum_{qrs}  \elm{\chibra{\beta}}{W_{rs}}{\phiket{q}} P_{qsor} \nn
    &= \sum_{qrs}
    \int \chibra{\beta} (\mathbf{x}) \left[ 
    \int \phibra{r}(\mathbf{y}) u(\mathbf{x}, \mathbf{y}) \phiket{s}(\mathbf{y})  \dd{\mathbf{y}} 
    \right] \phiket{q} (\mathbf{x}) \dd{\mathbf{x}}
    P_{qsor} \nn
    &= \sum_{qrs}
    \iint \chibra{\beta} (\mathbf{x}) \phibra{r}(\mathbf{y}) u(\mathbf{x}, \mathbf{y}) \phiket{q} (\mathbf{x}) \phiket{s}(\mathbf{y}) \dd{\mathbf{x}} \dd{\mathbf{y}} 
    P_{qsor} \nn
    &= \sum_{qrs}  u_{\beta r q s} P_{qsor}. \label{eq:F_check_from_u_and_rho}
\end{align}
Using similar steps, Eq.~\eqref{eq:phibra_dot} leads to
\begin{align} \label{eq:C_tilde_dot}
    i \dot{\tilde{\mathbf{C}}} 
    &= -i  \bm{\eta} \tilde{\mathbf{C}} - 
    \big( \check{\mathbf{H}}' + \mathbf{D}^{-1} \check{\mathbf{F}}' \big) \mathbf{Q} \nn
    &= -i  \bm{\eta} \tilde{\mathbf{C}} - 
    \mathbf{D}^{-1} \big( \mathbf{D} \check{\mathbf{H}}' + \check{\mathbf{F}}' \big) \mathbf{Q}
\end{align}
with
\begin{gather}
    \check{H}'_{p \beta} = \elm{\phibra{p}}{h}{\chiket{\beta}} = h_{p \beta},  \\
    \check{F}'_{o \beta} = \sum_{qrs} P_{osqr} u_{qr\beta s}.\label{eq:F_check_prime_from_u_and_rho}
\end{gather}
When the active basis is orthogonal ($\tilde{\mathbf{C}} = \mathbf{C}^{\dagger}$), we gain a lot of
additional structure, at least when the primitive basis is also taken to be orthogonal:
\begin{gather}
    \mathbf{Q}^{\dagger}          = \mathbf{Q}, \quad 
    \mathbf{D}^{\dagger}          = \mathbf{D}, \quad 
    (\mathbf{D}^{-1})^{\dagger}   = \mathbf{D}^{-1} \\
    \check{\mathbf{H}}^{\dagger}  = \check{\mathbf{H}}^{\prime}, \quad 
    \check{\mathbf{F}}^{\dagger}  = \check{\mathbf{F}}^{\prime}, \quad
    \bm{\eta}^{\dagger}           = -\bm{\eta}
\end{gather}
All of these (except the last) are easy to show and imply that
$\dot{\mathbf{C}}^{\dagger} = \dot{\tilde{\mathbf{C}}}$ as expected;
see Eqs.~\eqref{eq:C_dot} and \eqref{eq:C_tilde_dot}.

\section{Relation to other work}
\subsection{Biorthogonal case}
In Refs.~\citenum{madsenTimedependentVibrationalCoupled2020} and \citenum{hojlundBivariationalTimedependentWave2022},
the parameter equations were derived (for the biorthogonal case) by assuming the expansions in
Eqs.~\eqref{eq:phi_ket_expansion} and \eqref{eq:phi_bra_expansion} from the outset.
Those derivations also apply to the electronic structure problem
(this is an explicit point in Ref.\citenum{hojlundBivariationalTimedependentWave2022}), so we
should check that they agree with Eqs.~\eqref{eq:C_dot} and \eqref{eq:C_tilde_dot}.
Ignoring notational differences, we need to check that
\begin{align}
    \big[ \check{\mathbf{H}} \mathbf{D} + \check{\mathbf{F}} \big]_{\bar{\alpha} \bar{p}}
    &= \elm{\tilde{\Psi}}{ \crea{\bar{p}} [\anniprim{\bar{\alpha}}, H] }{\Psi},  \label{eq:F_check_correspondence} \\
    \big[ \mathbf{D} \check{\mathbf{H}}' + \check{\mathbf{F}}' \big]_{\bar{p} \bar{\alpha}} 
    &= \elm{\tilde{\Psi}}{ [H, \creaprim{\bar{\alpha}}] \anni{\bar{p}}  }{\Psi}.  \label{eq:F_check_prime_correspondence}
\end{align}
Here, the operators $\creaprim{\bar{\alpha}}$ and $\anniprim{\bar{\alpha}}$ create and annihilate
the primitive basis. We note that
\begin{align}
    \{ \anniprim{\bar{\alpha}}, \crea{p} \} &= C_{\bar{\alpha} p}, \\
    \{ \anniprim{\bar{\alpha}}, \anni{p} \} &= 0, \\
    \{ \anni{p}, \creaprim{\bar{\alpha}} \} &= \tilde{C}_{p \bar{\alpha}}, \\
    \{ \crea{p}, \creaprim{\bar{\alpha}} \} &= 0,
\end{align}
which implies the following commutators:
\begin{align}
    [\anniprim{\bar{\alpha}}, \crea{p} \anni{q}] 
    &= \{ \anniprim{\bar{\alpha}}, \crea{p} \} \anni{q} - \crea{p} \{ \anniprim{\bar{\alpha}}, \anni{q} \} \nn
    &= C_{\bar{\alpha} p} \anni{q}
\end{align}
%
\begin{align}
    [\crea{p} \anni{q}, \creaprim{\bar{\alpha}}] 
    &= - \{ \crea{p}, \creaprim{\bar{\alpha}} \} \anni{q} + \crea{p} \{ \anni{q}, \creaprim{\bar{\alpha}} \} \nn
    &= \crea{p} \tilde{C}_{q \bar{\alpha}} 
\end{align}
%
\begin{align}
    [\anniprim{\bar{\alpha}}, \crea{p} \crea{q} \anni{s} \anni{r}] 
    &= \{ \anniprim{\bar{\alpha}}, \crea{p} \} \crea{q} \anni{s} \anni{r} 
     - \crea{p} \{ \anniprim{\bar{\alpha}}, \crea{q} \} \anni{s} \anni{r}
     + \crea{p} \crea{q} \{ \anniprim{\bar{\alpha}}, \anni{s} \} \anni{r}
     - \crea{p} \crea{q} \anni{s} \{ \anniprim{\bar{\alpha}}, \anni{r} \}  \nn
    &= C_{\bar{\alpha} p} \crea{q} \anni{s} \anni{r} - C_{\bar{\alpha} q} \crea{p} \anni{s} \anni{r}
\end{align}
%
\begin{align}
    [\crea{p} \crea{q} \anni{s} \anni{r}, \creaprim{\bar{\alpha}} ] 
    &= 
    - \{ \crea{p}, \creaprim{\bar{\alpha}} \} \crea{q} \anni{s} \anni{r} 
    + \crea{p} \{ \crea{q}, \creaprim{\bar{\alpha}} \} \anni{s} \anni{r}
    - \crea{p} \crea{q} \{ \anni{s}, \creaprim{\bar{\alpha}} \} \anni{r}
    + \crea{p} \crea{q} \anni{s} \{ \anni{r}, \creaprim{\bar{\alpha}} \}  \nn
    &= -\crea{p} \crea{q} \anni{r} \tilde{C}_{s \bar{\alpha}} + \crea{p} \crea{q} \anni{s} \tilde{C}_{r \bar{\alpha}} 
\end{align}
The right-hand side of Eq.~\eqref{eq:F_check_correspondence} now becomes
\begin{align}
    \elm{\tilde{\Psi}}{ \crea{\bar{p}} [\anniprim{\bar{\alpha}}, H] }{\Psi} 
    &= \sum_{pq} h_{pq} \elm{\tilde{\Psi}}{ \crea{\bar{p}} [\anniprim{\bar{\alpha}}, \crea{p} \anni{q}] }{\Psi}
    + \frac{1}{2} \sum_{pqrs} u_{pqrs} \elm{\tilde{\Psi}}{ \crea{\bar{p}} [\anniprim{\bar{\alpha}}, \crea{p} \crea{q} \anni{s} \anni{r}] }{\Psi} \nn
    &= 
    \begin{multlined}[t]
        \sum_{pq} C_{\bar{\alpha} p} h_{pq} \elm{\tilde{\Psi}}{ \crea{\bar{p}} \anni{q} }{\Psi} \\
        + \frac{1}{2} \sum_{pqrs} \left( 
            C_{\bar{\alpha} p} u_{pqrs} \elm{\tilde{\Psi}}{ \crea{\bar{p}} \crea{q} \anni{s} \anni{r} }{\Psi} -
            C_{\bar{\alpha} q} u_{pqrs} \elm{\tilde{\Psi}}{ \crea{\bar{p}} \crea{p} \anni{s} \anni{r} }{\Psi}
        \right)
    \end{multlined} \nn
    &=  \sum_{pq} C_{\bar{\alpha} p} h_{pq} \rho_{q \bar{p}}
    + \frac{1}{2} \sum_{pqrs} \left( 
        C_{\bar{\alpha} p} u_{pqrs} \rho_{rs \bar{p} q} -
        C_{\bar{\alpha} q} u_{pqrs} \rho_{rs \bar{p} p}
    \right) \label{eq:F_check_correspondence_proof_1}
\end{align}
The last term can be simplified by renaming summation indices ($p \leftrightarrow q$ and $r \leftrightarrow s$)
followed by the identities $u_{qpsr} = u_{pqrs}$ and
$\rho_{sr\bar{p}q} = -\rho_{rs\bar{p}q}$:
\begin{align}
       \sum_{pqrs} C_{\bar{\alpha} q} u_{pqrs} \rho_{rs \bar{p} p} 
    =  \sum_{pqrs} C_{\bar{\alpha} p} u_{qpsr} \rho_{sr \bar{p} q}
    = -\sum_{pqrs} C_{\bar{\alpha} p} u_{pqrs} \rho_{rs \bar{p} q}.
\end{align}
Combining this with Eq.~\eqref{eq:F_check_correspondence_proof_1} now yields
\begin{align}
    \elm{\tilde{\Psi}}{ \crea{\bar{p}} [\anniprim{\bar{\alpha}}, H] }{\Psi} 
    &= \sum_{pq}   C_{\bar{\alpha} p} h_{pq}   \rho_{q \bar{p}}
    +  \sum_{pqrs} C_{\bar{\alpha} p} u_{pqrs} \rho_{rs \bar{p} q}  \nn
    &= \sum_{q}    h_{\bar{\alpha} q}   \rho_{q \bar{p}}
    +  \sum_{qrs}  u_{\bar{\alpha} qrs} \rho_{rs \bar{p} q}
    \label{eq:F_check_correspondence_proof_2}
\end{align}
which agrees with Eqs.~\eqref{eq:F_check_from_u_and_rho} and \eqref{eq:F_check_correspondence}.
In the last step we have used
\begin{align}
    \sum_{p}  C_{\bar{\alpha} p} h_{pq} 
    = \sum_{p \beta} C_{\bar{\alpha} p} \tilde{C}_{p \beta} h_{\beta q}
    = h_{\bar{\alpha} q}.
\end{align}
This holds if
\begin{align} \label{eq:C_C_tilde_inverse}
    \sum_{p \beta} C_{\bar{\alpha} p} \tilde{C}_{p \beta} = \delta_{\bar{\alpha} \beta},
\end{align}
which is \textit{not} true if the $p$ summation runs over active (occupied and virtual) orbitals. However,
since the primitive basis is finite,
we are free to temporarily introduce the secondary basis (i.e. the complement of the active basis) explicitly.
This means that $\mathbf{C}$ and $\tilde{\mathbf{C}}$ become square (rather than rectangular) matrices:
\begin{alignat}{2}
    \mathbf{C} 
    &= 
    \left[
	\begin{array}{c}
        \mathbf{C}_{\textsc{A}}
	\end{array} \right]
    %
    {} &&\rightarrow
    \left[
	\begin{array}{c | c}
        \mathbf{C}_{\textsc{A}} {\,} & {\,} \mathbf{C}_{\textsc{S}} 
	\end{array} \right] \\
    %%%%
    \tilde{\mathbf{C}} 
    &= 
    \left[
	\begin{array}{c}
        \tilde{\mathbf{C}}_{\textsc{A}}
	\end{array} \right]
    %
    {} &&\rightarrow
    \left[
	\begin{array}{c}
        \tilde{\mathbf{C}}_{\textsc{A}} \\
        \hline
        \tilde{\mathbf{C}}_{\textsc{S}} 
	\end{array} \right]
\end{alignat}
Since the full matrices are square we get that biorthogonality ($\tilde{\mathbf{C}} \mathbf{C} = \mathbf{1}$)
implies $\mathbf{C}  \tilde{\mathbf{C}} = \mathbf{1}$, which is exactly Eq.~\eqref{eq:C_C_tilde_inverse}.
We will never actually construct the secondary basis; we only need its \textit{existence} to complete the proof.
A similar derivation shows that
\begin{align} \label{eq:F_check_prime_correspondence_proof_2}
    \elm{\tilde{\Psi}}{ [H, \creaprim{\bar{\alpha}}] \anni{\bar{p}}  }{\Psi}
    = \sum_{p} \rho_{\bar{p}p} h_{p \bar{\alpha}} + \sum_{pqs} \rho_{\bar{p}spq} u_{pq\bar{\alpha}s},
\end{align}
which agrees with Eqs.~\eqref{eq:F_check_prime_from_u_and_rho} and \eqref{eq:F_check_prime_correspondence}.

\subsection{Orthogonal case}

In the orthogonal case, one can also derive the parameter equations
by assuming the expansion in a primitive basis from the outset.
These equations are not yet published, but the thing we need to check is
that
\begin{align}
    \big[ \check{\mathbf{H}} \mathbf{D} + \check{\mathbf{F}} \big]_{\bar{\alpha} \bar{p}}
    &= \frac{1}{2} \left( 
        \elm{\tilde{\Psi}}{ \crea{\bar{p}} [\anniprim{\bar{\alpha}}, H] }{\Psi} + 
        \elm{\tilde{\Psi}}{ [H, \creaprim{\bar{\alpha}}] \anni{\bar{p}} }{\Psi}^* 
    \right).
    \label{eq:F_check_correspondence_orthogonal}
\end{align}
We can reuse Eqs.~\eqref{eq:F_check_correspondence_proof_2} and \eqref{eq:F_check_prime_correspondence_proof_2}
for the commutators as well as the permutation symmetries
\begin{align}
    h_{p \bar{\alpha}}^*     &= h_{\bar{\alpha} p}, \\
    u_{p q \bar{\alpha} s}^* &= u_{\bar{\alpha} s p q},
\end{align}
which hold when the active and primitive bases are both orthogonal. After some renaming
of summation indices, one indeed finds that
\begin{align}
    \frac{1}{2} \left( 
        \elm{\tilde{\Psi}}{ \crea{\bar{p}} [\anniprim{\bar{\alpha}}, H] }{\Psi} + 
        \elm{\tilde{\Psi}}{ [H, \creaprim{\bar{\alpha}}] \anni{\bar{p}} }{\Psi}^* 
    \right)
    = \sum_{q} h_{\bar{\alpha} q} D_{q \bar{p}} + \sum_{qrs} u_{\bar{\alpha} q r s} P_{rs \bar{p} q},
\end{align}
in agreement with Eqs.~\eqref{eq:F_check_from_u_and_rho} and \eqref{eq:F_check_correspondence_orthogonal}.


\section{Detailed derivation of orbital equations}
\subsection{Biorthogonal case}
This derivation follows the appendix of Ref.~\citenum{kvaalInitioQuantumDynamics2012}
quite closely, but explains the steps in more detail. We consider a complex
action functional,
\begin{align}
    \mathcal{S} = \int_{t_0}^{t_1} \mathcal{L} \dd{t}, \quad \mathcal{L} = \elm{\tilde{\Psi}}{(i \partial_t - H)}{\Psi},
\end{align}
which we will make stationary ($\delta \mathcal{S} = 0$) with respect to independent
and arbitrary variations that vanish at the end points. 

We will consider bra and ket states that depend on a set of correlation
parameters $\bm{\alpha}$ as well as the active bra and ket orbitals,
$\{ \phibra{p} \}$ and $\{ \phiket{p} \}$. The orbitals stand in 
a one-to-one relationship with the corresponding annihilators
and creators, $\{ \anni{p} \}$ and $\{ \crea{p} \}$, and
we will use the `first-quantized' orbitals and the `second-quantized'
elementary operators more or less interchangeably, depending on
context and convenience.
For the traditional coupled cluster
ansatz, the correlation parameters are of course the amplitudes
$\bm{\alpha} = \{ \lambda_\mu, t_\mu \}$, but we could consider
other options such extended coupled cluster or bivariational CI-expansions.

In order to compute the Lagrangian $\mathcal{L}$, we need to consider
the action of the time-derivative on the ket. It is useful to start by
considering a single Slater determinant (in the spin-orbital basis):
\begin{align}
    \ket{\mu} = \prod_{k=1}^N \creasuper{p}{k} \ket{\mathrm{vac}}.
\end{align}
Here, $N$ denotes the number of electrons. 
We can think
of $\mu$ as a set of integers that specifies
the occupied spin orbitals, i.e.
\begin{align}
    \mu = (p^1, p^2, \ldots, p^N).
\end{align}
This is not an occupation number vector
in the sense of Helgaker et al.,\cite{helgakerMolecularElectronicstructureTheory2000}
but it contains the same information. The integers $p^k$
are distinct, since we are working in the spin-orbital basis.
The time-derivative of
$\ket{\mu}$ is evaluated using the product rule:
\begin{align}
    \ket{\dot{\mu}} = \sum_{l=1}^{N} \left( \, \prod_{k < l} \creasuper{p}{k} \right) \creasuperdot{p}{l} \left( \, \prod_{k > l} \creasuper{p}{k} \right) \ket{\mathrm{vac}}.
\end{align}
Now, $\{ \crea{p}, \creadot{q} \} = 0$, so we can move $\creasuperdot{p}{l}$ all the way to the left in each term
by changing the sign $l - 1$ times, i.e.
\begin{align}
    \ket{\dot{\mu}} = \sum_{l=1}^{N} (-1)^{l-1} \, \creasuperdot{p}{l} \left( \, \prod_{k \neq l} \creasuper{p}{k} \right) \ket{\mathrm{vac}}.
\end{align}
Next, we insert
\begin{align} \label{eq:clever_1}
    1 = \{ \annisuper{p}{l}, \creasuper{p}{l} \} = \annisuper{p}{l} \creasuper{p}{l} + \creasuper{p}{l} \annisuper{p}{l}
\end{align}
to the right of $\creasuperdot{p}{l}$ and note that $\{ \annisuper{p}{l}, \creasuper{p}{k} \} = 0$ for $l \neq k$.
We can thus move $\annisuper{p}{l}$ in the second term of Eq.~\eqref{eq:clever_1} all the way to right
(under suitable sign changes), where it annihilates the vacuum. Hence, only the first term survives:
\begin{align}
    \ket{\dot{\mu}} = \sum_{l=1}^{N} (-1)^{l-1} \, \creasuperdot{p}{l} \annisuper{p}{l} \creasuper{p}{l} \left( \, \prod_{k \neq l} \creasuper{p}{k} \right) \ket{\mathrm{vac}}.
\end{align}
Finally, $\creasuper{p}{l}$ is moved to the $l$th slot in the product by changing the sign $l - 1$ times.
The two factors of $(-1)^{l-1}$ cancel, leaving us with
\begin{align}
    \ket{\dot{\mu}} 
    &= \sum_{l=1}^{N}  \creasuperdot{p}{l} \annisuper{p}{l}  \left( \, \prod_{k=1}^{N} \creasuper{p}{k} \right) \ket{\mathrm{vac}} \nn
    &= \sum_{l=1}^{N}  \creasuperdot{p}{l} \annisuper{p}{l}  \ket{\mu} \nn
    &= \sum_{p}        \creadot{p} \anni{p} \ket{\mu}.
\end{align}
In the last step we have added terms for each of the orbitals that are not present in $\ket{\mu}$. These terms vanish, since the annihilator
$\anni{p}$ can be moved all the way to right for $p \notin \mu$. We now have an expression that does not refer to the specific orbitals
in $\ket{\mu}$, so it must hold for all $\ket{\mu}$. We thus write
\begin{align}
    \ket{\dot{\mu}} = D \ket{\mu}, \quad D = \sum_{p} \creadot{p} \anni{p}
\end{align}
with the sum running over all active orbitals. For a bra Slater determinant, the same kind of proof yields
\begin{align}
    \bra{\dot{\tilde{\mu}}} = \bra{\tilde{\mu}} \sum_{p} \crea{p} \annidot{p}.
\end{align}
We will also need the variation of bra and ket determinants, but since
the (first-order) variation satisfies the product rule (Leibniz rule) just like
the time derivative, the proofs are identical (the time derivative is, in fact,
an allowed variation). The result is simply
\begin{align}
    \ket{\delta \mu}         &= \sum_{p} (\creavar{p}) \anni{p} \ket{\mu} \\
    \bra{\delta \tilde{\mu}} &= \bra{\tilde{\mu}} \sum_{p} \crea{p} (\annivar{p}).
\end{align}
It is useful at this point to consider what the allowed
orbital variations look like. The variations should be
arbitrary under the constraint that they
conserve biorthogonality, i.e. the overlap
$\braket{\phibra{p} | \phiket{q}} = \delta_{pq}$
should be conserved:
\begin{align}
    0 = \delta \braket{\phibra{p} | \phiket{q}} = 
    \braket{\phibravar{p} | \phiket{q}} + \braket{\phibra{p} | \phiketvar{q}}.
\end{align}
This is trivially satisfied if
\begin{subequations} \label{eq:bra_ket_variation_link}
    \begin{align}
        \braket{\phibra{p} | \phiketvar{q}} &= +\epsilon_{pq} \\
        \braket{\phibravar{p} | \phiket{q}} &= -\epsilon_{pq},
    \end{align}
\end{subequations}
where $\epsilon_{pq}$ is an arbitrary scalar.
Equations~\eqref{eq:bra_ket_variation_link} show very clearly how the
variations of the bra and ket orbitals are linked by the biorthogonality
constraints.
This link can be utilized by
introducing the projector onto the active single-particle space,
\begin{align} \label{eq:P_proj_def}
    P = \sum_{p}  \ket{\phiket{p}} \! \bra{\phibra{p}},
\end{align}
and the projector onto the complement of the active space
(the secondary space),
\begin{align} \label{eq:Q_proj_def}
    Q = 1 - P.
\end{align}
We note that the secondary space need not, formally speaking, be finite dimensional.
The precise nature of the secondary space is in some sense defined by
the identity operator in Eq.~\eqref{eq:Q_proj_def}. Specifying what
is meant by this operator uniquely specifies the secondary space;
see e.g. Eq.~\eqref{eq:Q_proj_matrix}. By definition, we have
\begin{align}
    1 = P + Q
\end{align}
so that
\begin{align}
    \ket{\phiketvar{q}} 
    &= (P + Q) \ket{\phiketvar{q}} \nn
    &= \sum_{p}  \ket{\phiket{p}} \! \braket{{\phibra{p}} | \phiketvar{q}} + Q \ket{\phiketvar{q}} \nn
    &\equiv \sum_{p} \ket{\phiket{p}} \epsilon_{pq} + \ket{\theta_q}.
\end{align}
For the bra orbitals we write
\begin{align}
    \bra{\phibravar{p}} 
    &= \bra{\phibravar{p}} (P + Q) \nn
    &= \sum_{q} \braket{\phibravar{p} | \phiket{q}} \! \bra{\phibra{q}}
    + \bra{\phibravar{p}} Q  \nn
    &\equiv
    \sum_{q} (-\epsilon_{pq}) \bra{\phibra{q}} + \bra{\tilde{\theta}_p}.
\end{align}
We have now parameterized the allowed orbital
variations
in terms of the (arbitrary) scalars $\epsilon_{pq}$ 
and the functions $\ket{\theta_q}$ and $\bra{\tilde{\theta}_p}$,
which satisfy
$\ket{\theta_q} = Q \ket{\theta_q} $ and
$\bra{\tilde{\theta}_p} = \bra{\tilde{\theta}_p} Q$, but are otherwise
arbitrary. While the
$P$-space variations are linked by
the $\epsilon_{pq}$, we stress that the $Q$-space variations are completely independent.




% The fact that
% the variations are independent allows us to vary each variable separately
% (rather than varying everything at once).


\section{Further ideas}
\begin{itemize}
    \item Ground state in exponential parameterization?
    \item Detailed derivation of mean-field operators for vibrational case.
\end{itemize}

\newpage
\bibliography{bib/madsgh.bib}

\end{document}
